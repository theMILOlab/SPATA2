<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spatial measures - Code &amp; Concept • SPATA2</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Spatial measures - Code &amp; Concept">
<meta property="og:description" content="SPATA2">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SPATA2</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/spata-v2-installation.html">Installation</a>
</li>
<li>
  <a href="../articles/spata-v2-spata-data.html">SPATAData</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Around the spata2 object</li>
    <li>
      <a href="../articles/spata-v2-object-initiation-and-manipulation.html">Object Set Up and Manipulation</a>
    </li>
    <li>
      <a href="../articles/spata-v2-platform-compatibility.html">Platform Compatibility</a>
    </li>
    <li>
      <a href="../articles/spata-v2-autoencoder.html">Autoencoder</a>
    </li>
    <li>
      <a href="../articles/spata-v2-genes-gene-sets-and-features.html">Genes, Gene Sets and Features</a>
    </li>
    <li class="dropdown-header">Image Analysis</li>
    <li>
      <a href="../articles/spata-v2-image-handling.html">Image Handling</a>
    </li>
    <li>
      <a href="../articles/spata-v2-image-annotations.html">Image Annotations</a>
    </li>
    <li>
      <a href="../articles/spata-v2-spatial-segmentation.html">Spatial Segmentation</a>
    </li>
    <li class="dropdown-header">Analysis of Gene Expression</li>
    <li>
      <a href="../articles/spata-v2-cnv-analysis.html">Copy Number Variations</a>
    </li>
    <li>
      <a href="../articles/spata-v2-clustering.html">Clustering</a>
    </li>
    <li>
      <a href="../articles/spata-v2-dea.html">Differential Expression</a>
    </li>
    <li>
      <a href="../articles/spata-v2-gsea.html">Gene Set Enrichment</a>
    </li>
    <li class="dropdown-header">Expression Gradients &amp; Gradient Screening</li>
    <li>
      <a href="../articles/spata-v2-spatial-trajectories.html">Spatial Trajectories</a>
    </li>
    <li>
      <a href="../articles/spata-v2-spatial-trajectory-screening.html">Spatial Trajectory Screening</a>
    </li>
    <li>
      <a href="../articles/spata-v2-image-annotation-screening.html">Image Annotation Screening</a>
    </li>
    <li>
      <a href="../articles/spata-v2-scd.html">Integrate Single Cell Deconvolution</a>
    </li>
    <li class="dropdown-header">Visualization</li>
    <li>
      <a href="../articles/spata-v2-plotting-surface.html">Surface Plotting</a>
    </li>
    <li>
      <a href="../articles/spata-v2-plotting-misc.html">Miscellaneous</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Code &amp; Concept
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/cc-spatial-measures.html">Spatial Measures</a>
    </li>
    <li>
      <a href="../articles/cc-spatial-segmentation-vs-image-annotations.html">Spatial Segmentation vs. Image Annotations</a>
    </li>
    <li>
      <a href="../articles/cc-spatial-trajectory-screening.html">Spatial Trajectory Screening</a>
    </li>
    <li>
      <a href="../articles/cc-image-annotation-screening.html">Image Annotation Screening</a>
    </li>
    <li>
      <a href="../articles/cc-model-fitting-in-spatial-transcriptomic-studies.html">Model Fitting</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Spatial measures - Code &amp; Concept</h1>
            
      
      
      <div class="hidden name"><code>cc-spatial-measures.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="prerequisites">1. Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites"></a>
</h2>
<p>None.</p>
</div>
<div class="section level2">
<h2 id="introduction">2. Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Many questions researchers try to answer in spatial transcriptomics
and image analysis are space related. Coordinates of the observational
units - in most cases barcode-spots - are scaled to the resolution of
the image that is currently in use. If one exchanges the
<em>tissue_lowres_image.png</em> with the
<em>tissue_hires_image.png</em> from the 10X Visium output, the
coordinates of the barcode-spots are scaled accordingly to ensure that
both, coordinates and image, stay aligned. Thus, coordinates can be used
to answer spatial questions in relative but not in absolute measures.
For instance, the statement: “The necrotic region spans an area of
approximately 400pixels.” is useless as the actual area will always
depend on the image resolution. The high resolution plot below contains
more pixel than the low resolution plot. This affects the coordinate
range of the barcode-spots, too, as the ranges of the x- and y-axes
display.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://themilolab.com/" class="external-link">SPATA2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">SPATAData</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span>

<span class="co"># download object</span>
<span class="va">object_t313_highres</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/downloadSpataObject.html">downloadSpataObject</a></span><span class="op">(</span>sample_name <span class="op">=</span> <span class="st">"313_T"</span><span class="op">)</span>

<span class="co"># load image annotations</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"image_annotations"</span><span class="op">)</span>

<span class="va">object_t313_highres</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="../reference/setImageAnnotation.html">setImageAnnotation</a></span><span class="op">(</span>
    object <span class="op">=</span> <span class="va">object_t313_highres</span>, 
    img_ann <span class="op">=</span> <span class="va">image_annotations</span><span class="op">[[</span><span class="st">"313_T"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"necrotic_center"</span><span class="op">]</span><span class="op">]</span>
  <span class="op">)</span>

<span class="co"># downscale everything to a low resolution object</span>
<span class="va">object_t313_lowres</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/scaleAll.html">scaleAll</a></span><span class="op">(</span><span class="va">object_t313_highres</span>, scale_fct <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span>

<span class="co"># create high and low resolution plots</span>
<span class="va">text_size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">17.5</span><span class="op">)</span><span class="op">)</span>

<span class="va">low_res_plot</span> <span class="op">&lt;-</span>   
  <span class="fu"><a href="../reference/plotImageGgplot.html">plotImageGgplot</a></span><span class="op">(</span><span class="va">object_t313_lowres</span>, unit <span class="op">=</span> <span class="st">"px"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>subtitle <span class="op">=</span> <span class="st">"Low resolution"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="va">text_size</span>

<span class="va">high_res_plot</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="../reference/plotImageGgplot.html">plotImageGgplot</a></span><span class="op">(</span><span class="va">object_t313_highres</span>, unit <span class="op">=</span> <span class="st">"px"</span> <span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>subtitle <span class="op">=</span> <span class="st">"High resolution"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="va">text_size</span>

<span class="co"># plot results</span>
<span class="va">low_res_plot</span>

<span class="va">high_res_plot</span></code></pre></div>
<div class="figure">
<img src="cc-spatial-measures_files/figure-html/unnamed-chunk-3-1.png" alt="Fig.1 Different resolutions result in different x- and y-scale." width="50%"><img src="cc-spatial-measures_files/figure-html/unnamed-chunk-3-2.png" alt="Fig.1 Different resolutions result in different x- and y-scale." width="50%"><p class="caption">
Fig.1 Different resolutions result in different x- and y-scale.
</p>
</div>
</div>
<div class="section level2">
<h2 id="the-pixel-scale-factor">3. The pixel scale factor<a class="anchor" aria-label="anchor" href="#the-pixel-scale-factor"></a>
</h2>
<p>To answer questions in absolute measures, distances must be converted
to units of the <a href="https://en.wikipedia.org/wiki/International_System_of_Units#:~:text=The%20SI%20comprises%20a%20coherent,candela%20(cd%2C%20luminous%20intensity)" class="external-link">*Système
international d’unités (SI)</a>. That is, micrometers, millimeters,
centimeters, etc. This is possible as most spatial -omic studies come
with a ground truth. In case of <a href="https://kb.10xgenomics.com/hc/en-us/articles/360035487572-What-is-the-spatial-resolution-and-configuration-of-the-capture-area-of-the-Visium-Gene-Expression-Slide-" class="external-link">10XVisium</a>
this ground truth is the center to center distance between two adjacent
barcode-spots which is always 100um. Using this information, the actual
distances and areas can be computed with a pixel scale factor.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># how many um is one pixel in side lengths</span>
<span class="fu"><a href="../reference/getPixelScaleFactor.html">getPixelScaleFactor</a></span><span class="op">(</span><span class="va">object_t313_lowres</span>, unit <span class="op">=</span> <span class="st">"um"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 17.47339</span>
<span class="co">## attr(,"unit")</span>
<span class="co">## [1] "um/px"</span></code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># how many pixel is one um in side lengths</span>
<span class="fu"><a href="../reference/getPixelScaleFactor.html">getPixelScaleFactor</a></span><span class="op">(</span><span class="va">object_t313_lowres</span>, unit <span class="op">=</span> <span class="st">"um"</span>, switch <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 0.05722988</span>
<span class="co">## attr(,"unit")</span>
<span class="co">## [1] "px/um"</span></code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># how many um is one pixel in side lengths in case of a higher resolution?</span>
<span class="fu"><a href="../reference/getPixelScaleFactor.html">getPixelScaleFactor</a></span><span class="op">(</span><span class="va">object_t313_highres</span>, unit <span class="op">=</span> <span class="st">"um"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 4.368347</span>
<span class="co">## attr(,"unit")</span>
<span class="co">## [1] "um/px"</span></code></pre>
<p>Using scale factors the actual distances can be used in surface
plots. Note how the x- and y-axes of the low- and the high resolution
plot do <strong>not</strong> change if they are scaled according to the
SI units of length.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># creates axes in SI units</span>
<span class="va">axes_si_low_res</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="../reference/ggpLayerAxesSI.html">ggpLayerAxesSI</a></span><span class="op">(</span>
    object <span class="op">=</span> <span class="va">object_t313_lowres</span>, 
    unit <span class="op">=</span> <span class="st">"mm"</span>, 
    breaks_x <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html" class="external-link">str_c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">8</span>, <span class="st">"mm"</span><span class="op">)</span>, <span class="co"># use mm </span>
    breaks_y <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html" class="external-link">str_c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">8</span>, <span class="st">"mm"</span><span class="op">)</span>
  <span class="op">)</span>

<span class="va">axes_si_high_res</span> <span class="op">&lt;-</span> 
    <span class="fu"><a href="../reference/ggpLayerAxesSI.html">ggpLayerAxesSI</a></span><span class="op">(</span>
      object <span class="op">=</span> <span class="va">object_t313_highres</span>, <span class="co"># object that contains the high res. image! </span>
      unit <span class="op">=</span> <span class="st">"mm"</span>, 
      breaks_x <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html" class="external-link">str_c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">8</span>, <span class="st">"mm"</span><span class="op">)</span>,
      breaks_y <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html" class="external-link">str_c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">8</span>, <span class="st">"mm"</span><span class="op">)</span>
    <span class="op">)</span>

<span class="co"># plot results</span>
<span class="va">low_res_plot</span> <span class="op">+</span>
  <span class="va">axes_si_low_res</span> <span class="op">+</span> 
  <span class="va">text_size</span>

<span class="va">high_res_plot</span> <span class="op">+</span> 
  <span class="va">axes_si_high_res</span> <span class="op">+</span> 
  <span class="va">text_size</span></code></pre></div>
<div class="figure">
<img src="cc-spatial-measures_files/figure-html/unnamed-chunk-5-1.png" alt="Fig.2 Using SI units results in resolution independent scaling." width="50%"><img src="cc-spatial-measures_files/figure-html/unnamed-chunk-5-2.png" alt="Fig.2 Using SI units results in resolution independent scaling." width="50%"><p class="caption">
Fig.2 Using SI units results in resolution independent scaling.
</p>
</div>
<p>The following code chunks show how the pixel scale factor is
calculated.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># data.frame with spot to spot distances</span>
<span class="va">bcsp_dist</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="../reference/getBarcodeSpotDistances.html">getBarcodeSpotDistances</a></span><span class="op">(</span><span class="va">object_t313_lowres</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">bc_origin</span> <span class="op">!=</span> <span class="va">bc_destination</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>dist_round <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">distance</span>, digits <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span>

<span class="co"># keep only spot pairs with the lowest distance to bc_origin</span>
<span class="co"># -&gt; the neighbours</span>
<span class="va">bcsp_dist_neighbors</span> <span class="op">&lt;-</span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">bcsp_dist</span>, <span class="va">bc_origin</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">dist_round</span> <span class="op">==</span> <span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">dist_round</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>n_neighbors <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">bc_origin</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"bc"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"distance"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html" class="external-link">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="co"># if the spot does not lie exactly at the border, a spot has 6 neighbors</span>
<span class="va">bcsp_dist_neighbors</span></code></pre></div>
<pre><code><span class="co">## <span style="color: #949494;"># A tibble: 20,618 x 9</span></span>
<span class="co">##    bc_origin          bc_destination distance    xo    yo    xd    yd dist_round</span>
<span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;"> 1</span> AAACAAGTATCTCCCA-1 ACTAGTTGCGATC~     5.71  364. 310.   370. 310.           6</span>
<span class="co">## <span style="color: #BCBCBC;"> 2</span> AAACAAGTATCTCCCA-1 AGAGGCTTCGGAA~     5.72  364. 310.   361. 315.           6</span>
<span class="co">## <span style="color: #BCBCBC;"> 3</span> AAACAAGTATCTCCCA-1 CAGCAGTCCAGAC~     5.71  364. 310.   358. 310.           6</span>
<span class="co">## <span style="color: #BCBCBC;"> 4</span> AAACAAGTATCTCCCA-1 GCATCGGCCGTGT~     5.75  364. 310.   367. 305.           6</span>
<span class="co">## <span style="color: #BCBCBC;"> 5</span> AAACAAGTATCTCCCA-1 GGCAGCAAACCTA~     5.72  364. 310.   367. 315.           6</span>
<span class="co">## <span style="color: #BCBCBC;"> 6</span> AAACAAGTATCTCCCA-1 TTCTTATCCGCTG~     5.72  364. 310.   361. 305.           6</span>
<span class="co">## <span style="color: #BCBCBC;"> 7</span> AAACAATCTACTAGCA-1 ATAAACCATTGGA~     5.71  195.  77.3  201.  77.3          6</span>
<span class="co">## <span style="color: #BCBCBC;"> 8</span> AAACAATCTACTAGCA-1 CGCTACCGCCCTA~     5.72  195.  77.3  192.  72.4          6</span>
<span class="co">## <span style="color: #BCBCBC;"> 9</span> AAACAATCTACTAGCA-1 CTAAACGGGTGTA~     5.72  195.  77.3  192.  82.3          6</span>
<span class="co">## <span style="color: #BCBCBC;">10</span> AAACAATCTACTAGCA-1 GCGCGATGGGTCA~     5.71  195.  77.3  198.  72.4          6</span>
<span class="co">## <span style="color: #949494;"># i 20,608 more rows</span></span>
<span class="co">## <span style="color: #949494;"># i 1 more variable: n_neighbors &lt;int&gt;</span></span></code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">bcsp_dist_neighbors</span><span class="op">[[</span><span class="st">"n_neighbors"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 6 3 5 4 2 1</span></code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># create example df of bcsp with 6 neighbors</span>
<span class="va">six_n</span> <span class="op">&lt;-</span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">bcsp_dist_neighbors</span>, <span class="va">n_neighbors</span> <span class="op">==</span> <span class="fl">6</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_head</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">6</span><span class="op">)</span>

<span class="va">six_n</span></code></pre></div>
<pre><code><span class="co">## <span style="color: #949494;"># A tibble: 6 x 9</span></span>
<span class="co">##   bc_origin          bc_destination  distance    xo    yo    xd    yd dist_round</span>
<span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;">1</span> AAACAAGTATCTCCCA-1 ACTAGTTGCGATCG~     5.71  364.  310.  370.  310.          6</span>
<span class="co">## <span style="color: #BCBCBC;">2</span> AAACAAGTATCTCCCA-1 AGAGGCTTCGGAAA~     5.72  364.  310.  361.  315.          6</span>
<span class="co">## <span style="color: #BCBCBC;">3</span> AAACAAGTATCTCCCA-1 CAGCAGTCCAGACT~     5.71  364.  310.  358.  310.          6</span>
<span class="co">## <span style="color: #BCBCBC;">4</span> AAACAAGTATCTCCCA-1 GCATCGGCCGTGTA~     5.75  364.  310.  367.  305.          6</span>
<span class="co">## <span style="color: #BCBCBC;">5</span> AAACAAGTATCTCCCA-1 GGCAGCAAACCTAT~     5.72  364.  310.  367.  315.          6</span>
<span class="co">## <span style="color: #BCBCBC;">6</span> AAACAAGTATCTCCCA-1 TTCTTATCCGCTGG~     5.72  364.  310.  361.  305.          6</span>
<span class="co">## <span style="color: #949494;"># i 1 more variable: n_neighbors &lt;int&gt;</span></span></code></pre>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># create example df of bcsp with 2 neighbors</span>
<span class="va">two_n</span> <span class="op">&lt;-</span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">bcsp_dist_neighbors</span>, <span class="va">n_neighbors</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_head</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>

<span class="va">two_n</span></code></pre></div>
<pre><code><span class="co">## <span style="color: #949494;"># A tibble: 2 x 9</span></span>
<span class="co">##   bc_origin          bc_destination  distance    xo    yo    xd    yd dist_round</span>
<span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;">1</span> AGTAGCGTGAACGAAC-1 ACGCCCAGCTGTCG~     5.72  278.  72.3  275.  77.2          6</span>
<span class="co">## <span style="color: #BCBCBC;">2</span> AGTAGCGTGAACGAAC-1 CCTCGACCCACTGC~     5.72  278.  72.3  281.  77.2          6</span>
<span class="co">## <span style="color: #949494;"># i 1 more variable: n_neighbors &lt;int&gt;</span></span></code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># use info to color coordinates</span>

<span class="va">levels_loc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Two Neigh."</span>, <span class="st">"Six Neigh."</span>, <span class="st">"Neigh."</span>, <span class="st">"Neither"</span><span class="op">)</span>

<span class="va">plot_df</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="../reference/getCoordsDf.html">getCoordsDf</a></span><span class="op">(</span><span class="va">object_t313_lowres</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>
    localisation <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span>
      <span class="va">barcodes</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">six_n</span><span class="op">$</span><span class="va">bc_origin</span> <span class="op">~</span> <span class="st">"Six Neigh."</span>, 
      <span class="va">barcodes</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">six_n</span><span class="op">$</span><span class="va">bc_destination</span> <span class="op">~</span> <span class="st">"Neigh."</span>, 
      <span class="va">barcodes</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">two_n</span><span class="op">$</span><span class="va">bc_origin</span> <span class="op">~</span> <span class="st">"Two Neigh."</span>, 
      <span class="va">barcodes</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">two_n</span><span class="op">$</span><span class="va">bc_destination</span> <span class="op">~</span> <span class="st">"Neigh."</span>, 
      <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"Neither"</span>
    <span class="op">)</span>, 
    localisation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">localisation</span>, levels <span class="op">=</span> <span class="va">levels_loc</span><span class="op">)</span>
  <span class="op">)</span>

<span class="fu"><a href="../reference/plotSurface.html">plotSurface</a></span><span class="op">(</span>
  object <span class="op">=</span> <span class="va">plot_df</span>, 
  color_by <span class="op">=</span> <span class="st">"localisation"</span>, 
  pt_clrp <span class="op">=</span> <span class="st">"Set1"</span>, 
  clrp_adjust <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Neither"</span> <span class="op">=</span> <span class="st">"lightgrey"</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="../reference/legendBottom.html">legendColor</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="cc-spatial-measures_files/figure-html/unnamed-chunk-8-1.png" alt="Fig.3 Barcode-spots and their neighbors." width="100%"><p class="caption">
Fig.3 Barcode-spots and their neighbors.
</p>
</div>
<p>The distance of two neighbors in pixel units can be scaled to the
actual distance which is 100um in case of the Visium method.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dist_px</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">six_n</span><span class="op">[</span><span class="fl">1</span>,<span class="st">"distance"</span><span class="op">]</span><span class="op">)</span>
<span class="va">dist_um</span> <span class="op">&lt;-</span> <span class="fl">100</span> <span class="co"># 100um</span>

<span class="va">px_scale_fct</span> <span class="op">&lt;-</span> <span class="va">dist_um</span><span class="op">/</span><span class="va">dist_px</span>

<span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">px_scale_fct</span>, which <span class="op">=</span> <span class="st">"unit"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"um/px"</span>

<span class="va">px_scale_fct</span></code></pre></div>
<pre><code><span class="co">## [1] 17.50901</span>
<span class="co">## attr(,"unit")</span>
<span class="co">## [1] "um/px"</span></code></pre>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/getPixelScaleFactor.html">getPixelScaleFactor</a></span><span class="op">(</span><span class="va">object_t313_lowres</span>, unit <span class="op">=</span> <span class="st">"um"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 17.47339</span>
<span class="co">## attr(,"unit")</span>
<span class="co">## [1] "um/px"</span></code></pre>
<p>Note that the distance from one barcode-spot to its neighbors can
vary slightly within a few sub pixels. This makes the scale factor vary
within the variance of the neighbor to neighbor distance. The algorithm
to compute the pixel scale factor takes the median of all neighbor
distances to correct for that.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">dist_px_corr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">bcsp_dist_neighbors</span><span class="op">[[</span><span class="st">"distance"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="va">dist_um</span> <span class="op">&lt;-</span> <span class="fl">100</span>

<span class="va">px_scale_fct_corr</span> <span class="op">&lt;-</span> <span class="va">dist_um</span><span class="op">/</span><span class="va">dist_px_corr</span>

<span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">px_scale_fct_corr</span>, which <span class="op">=</span> <span class="st">"unit"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"um/px"</span>

<span class="va">px_scale_fct_corr</span>
<span class="co">## [1] 17.47339</span>
<span class="co">## attr(,"unit")</span>
<span class="co">## [1] "um/px"</span>

<span class="fu"><a href="../reference/getPixelScaleFactor.html">getPixelScaleFactor</a></span><span class="op">(</span><span class="va">object_t313_lowres</span>, unit <span class="op">=</span> <span class="st">"um"</span><span class="op">)</span>
<span class="co">## [1] 17.47339</span>
<span class="co">## attr(,"unit")</span>
<span class="co">## [1] "um/px"</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="working-with-distances">4. Working with distances<a class="anchor" aria-label="anchor" href="#working-with-distances"></a>
</h2>
<p>Multiple functions take arguments that, in some way, refer to
distance measures. SPATA2 makes use of the <a href="https://github.com/r-quantities/units" class="external-link"><code>units</code></a>
package to work with distances. If not explained otherwise in the
documentation you can provide the distance in pixel or in SI units.
Behind the scenes input is converted to pixel and aligned with the
current resolution. 4.1 Converting distances gives some examples of how
this is done.</p>
<div class="section level3">
<h3 id="handling-distance-input-and-output">4.1 Handling distance input and output<a class="anchor" aria-label="anchor" href="#handling-distance-input-and-output"></a>
</h3>
<p>Every SI unit of length is a valid distance unit.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="fu"><a href="../reference/validActivationFunctions.html">validUnitsOfLength</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">##  nanometer micrometer millimeter centimeter  decimeter      meter            </span>
<span class="co">##       "nm"       "um"       "mm"       "cm"       "dm"        "m"       "px"</span>

<span class="fu"><a href="../reference/validActivationFunctions.html">validUnitsOfLengthSI</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">##  nanometer micrometer millimeter centimeter  decimeter      meter </span>
<span class="co">##       "nm"       "um"       "mm"       "cm"       "dm"        "m"</span>

<span class="co"># wrappers around units::set_units()</span>
<span class="fu"><a href="../reference/as_unit.html">as_micrometer</a></span><span class="op">(</span>input <span class="op">=</span> <span class="st">"4mm"</span><span class="op">)</span>
<span class="co">## 4000 [um]</span>

<span class="fu"><a href="../reference/as_unit.html">as_millimeter</a></span><span class="op">(</span>input <span class="op">=</span> <span class="st">"4cm"</span><span class="op">)</span>
<span class="co">## 40 [mm]</span></code></pre></div>
<p>Pixel is not a valid distance unit in <code>units</code>. Pixel,
however, are important in image analysis. SPATA2 provides the wrappers
needed to reconcile both. They are named according to the unit of
interest. To transform between pixel and SI units of length the
<code>SPATA2</code> object must be provided as the scale factor is
needed. See the documentation of <code><a href="../reference/is_dist.html">?is_dist</a></code> to obtain more
information on how distance values must be specified.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co">### convert from si -&gt; pixel</span>

<span class="co"># example 1: a simple string works</span>
<span class="fu"><a href="../reference/as_unit.html">as_pixel</a></span><span class="op">(</span>input <span class="op">=</span> <span class="st">"4mm"</span>, object <span class="op">=</span> <span class="va">object_t313_lowres</span><span class="op">)</span>
<span class="co">## [1] 228.9195</span>
<span class="co">## attr(,"unit")</span>
<span class="co">## [1] "px"</span>

<span class="co"># example 2: a unit object works, too</span>
<span class="va">unit_input</span> <span class="op">&lt;-</span> <span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/units/man/units.html" class="external-link">set_units</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">4</span>, value <span class="op">=</span> <span class="st">"mm"</span><span class="op">)</span>

<span class="va">unit_input</span>
<span class="co">## 4 [mm]</span>

<span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">unit_input</span><span class="op">)</span>
<span class="co">## [1] "units"</span>

<span class="fu"><a href="../reference/as_unit.html">as_pixel</a></span><span class="op">(</span>input <span class="op">=</span> <span class="va">unit_input</span>, object <span class="op">=</span> <span class="va">object_t313_highres</span><span class="op">)</span>
<span class="co">## [1] 915.6781</span>
<span class="co">## attr(,"unit")</span>
<span class="co">## [1] "px"</span>


<span class="co">### convert from pixel -&gt; si</span>

<span class="co"># example 1: simple numeric input is interpreted as pixel</span>
<span class="fu"><a href="../reference/as_unit.html">as_millimeter</a></span><span class="op">(</span>
  input <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">200</span>, <span class="fl">300</span><span class="op">)</span>, 
  object <span class="op">=</span> <span class="va">object_t313_lowres</span>
  <span class="op">)</span>
<span class="co">## Units: [mm]</span>
<span class="co">## [1] 1.747339 3.494678 5.242017</span>
<span class="co"># example 2: strings with px suffix work, too</span>
<span class="fu"><a href="../reference/as_unit.html">as_micrometer</a></span><span class="op">(</span>
  input <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"50px"</span>, <span class="st">"200px"</span>, <span class="st">"800px"</span><span class="op">)</span>, 
  object <span class="op">=</span> <span class="va">object_t313_highres</span>
<span class="op">)</span>
<span class="co">## Units: [um]</span>
<span class="co">## [1]  218.4174  873.6695 3494.6778</span></code></pre></div>
<p>A major advantage of using SI units of length is that the input and
output of functions that depend on space remains the same regardless of
the image resolution that changes with every call to
<code><a href="../reference/exchangeImage.html">exchangeImage()</a></code>.</p>
</div>
<div class="section level3">
<h3 id="examples">4.2 Examples<a class="anchor" aria-label="anchor" href="#examples"></a>
</h3>
<p>The following are a few examples of where actual distances might come
into play.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># specifying x- and y-range while handling images</span>
<span class="va">xrange</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2.5mm"</span>, <span class="st">"6.5mm"</span><span class="op">)</span>
<span class="va">yrange</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"0.5mm"</span>, <span class="st">"4.5mm"</span><span class="op">)</span>

<span class="co"># where to set the breaks is a measure of distance, too</span>
<span class="va">breaks_x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html" class="external-link">str_c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">8</span>, <span class="st">"mm"</span><span class="op">)</span>
<span class="va">breaks_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html" class="external-link">str_c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">8</span>, <span class="st">"mm"</span><span class="op">)</span>

<span class="va">rect_add_on</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="../reference/ggpLayerRect.html">ggpLayerRect</a></span><span class="op">(</span>
    object <span class="op">=</span> <span class="va">object_t313_highres</span>, 
    xrange <span class="op">=</span> <span class="va">xrange</span>, 
    yrange <span class="op">=</span> <span class="va">yrange</span>
    <span class="op">)</span>

<span class="fu"><a href="../reference/plotImageGgplot.html">plotImageGgplot</a></span><span class="op">(</span>
  object <span class="op">=</span> <span class="va">object_t313_highres</span>,
  unit <span class="op">=</span> <span class="st">"mm"</span>, 
  breaks_x <span class="op">=</span> <span class="va">breaks_x</span>,
  breaks_y <span class="op">=</span> <span class="va">breaks_y</span>
  <span class="op">)</span> <span class="op">+</span> 
  <span class="va">rect_add_on</span> <span class="op">+</span>
  <span class="va">text_size</span>

<span class="fu"><a href="../reference/plotImageGgplot.html">plotImageGgplot</a></span><span class="op">(</span>
  object <span class="op">=</span> <span class="va">object_t313_highres</span>,
  unit <span class="op">=</span> <span class="st">"mm"</span>,
  xrange <span class="op">=</span> <span class="va">xrange</span>,
  yrange <span class="op">=</span> <span class="va">yrange</span>, 
  breaks_x <span class="op">=</span> <span class="va">breaks_x</span>,
  breaks_y <span class="op">=</span> <span class="va">breaks_y</span>
  <span class="op">)</span> <span class="op">+</span> 
  <span class="va">text_size</span></code></pre></div>
<div class="figure">
<img src="cc-spatial-measures_files/figure-html/unnamed-chunk-13-1.png" alt="Fig.4 Using SI units to specify distances and ranges." width="50%"><img src="cc-spatial-measures_files/figure-html/unnamed-chunk-13-2.png" alt="Fig.4 Using SI units to specify distances and ranges." width="50%"><p class="caption">
Fig.4 Using SI units to specify distances and ranges.
</p>
</div>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">theme_coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ggpLayerThemeCoords.html">ggpLayerThemeCoords</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># low resolution vs high resolution in pixel </span>
<span class="co"># -&gt; different inputs</span>
<span class="fu"><a href="../reference/plotSurfaceIAS.html">plotSurfaceIAS</a></span><span class="op">(</span>
  object <span class="op">=</span> <span class="va">object_t313_lowres</span>, 
  id <span class="op">=</span> <span class="st">"necrotic_center"</span>,
  distance <span class="op">=</span> <span class="fl">68.8</span>, 
  binwidth <span class="op">=</span> <span class="fl">6.8</span>, 
  display_bins_angle <span class="op">=</span> <span class="cn">FALSE</span>, 
  ggpLayers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>subtitle <span class="op">=</span> <span class="st">"Low res. - Pixel"</span><span class="op">)</span>, <span class="va">text_size</span>, <span class="va">theme_coords</span><span class="op">)</span>
<span class="op">)</span> 

<span class="fu"><a href="../reference/plotSurfaceIAS.html">plotSurfaceIAS</a></span><span class="op">(</span>
  object <span class="op">=</span> <span class="va">object_t313_highres</span>, 
  id <span class="op">=</span> <span class="st">"necrotic_center"</span>,
  distance <span class="op">=</span> <span class="fl">244</span>, 
  binwidth <span class="op">=</span> <span class="fl">24.4</span>, 
  display_bins_angle <span class="op">=</span> <span class="cn">FALSE</span>, 
  ggpLayers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>subtitle <span class="op">=</span> <span class="st">"High res. - Pixel"</span><span class="op">)</span>, <span class="va">text_size</span>, <span class="va">theme_coords</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<div class="figure">
<img src="cc-spatial-measures_files/figure-html/unnamed-chunk-14-1.png" alt="Fig.5 Using pixel lengths is error prone." width="50%"><img src="cc-spatial-measures_files/figure-html/unnamed-chunk-14-2.png" alt="Fig.5 Using pixel lengths is error prone." width="50%"><p class="caption">
Fig.5 Using pixel lengths is error prone.
</p>
</div>
<p>The input for <code>distance</code> and <code>binwidth</code> differs
between the two resolution if entered in pixel. One can avoid awkward
and error prone conversions by simply using the same input using SI
units.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># low resolution vs high resolution in si </span>
<span class="co"># -&gt; input remains the same -&gt; output remains the same (regardless of resolution)</span>
<span class="fu"><a href="../reference/plotSurfaceIAS.html">plotSurfaceIAS</a></span><span class="op">(</span>
  object <span class="op">=</span> <span class="va">object_t313_lowres</span>, 
  id <span class="op">=</span> <span class="st">"necrotic_center"</span>,
  distance <span class="op">=</span> <span class="st">"2000um"</span>, 
  binwidth <span class="op">=</span> <span class="st">"200um"</span>, <span class="co"># 2000um / 200um = 10</span>
  display_bins_angle <span class="op">=</span> <span class="cn">FALSE</span>, 
  ggpLayers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">axes_si_low_res</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>subtitle <span class="op">=</span> <span class="st">"Low res. - SI"</span><span class="op">)</span>, <span class="va">text_size</span>, <span class="va">theme_coords</span><span class="op">)</span>
<span class="op">)</span>

<span class="fu"><a href="../reference/plotSurfaceIAS.html">plotSurfaceIAS</a></span><span class="op">(</span>
  object <span class="op">=</span> <span class="va">object_t313_highres</span>, 
  id <span class="op">=</span> <span class="st">"necrotic_center"</span>,
  distance <span class="op">=</span> <span class="st">"2000um"</span>, 
  binwidth <span class="op">=</span> <span class="st">"200um"</span>, 
  display_bins_angle <span class="op">=</span> <span class="cn">FALSE</span>, 
  ggpLayers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">axes_si_high_res</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>subtitle <span class="op">=</span> <span class="st">"High res. - SI"</span><span class="op">)</span>, <span class="va">text_size</span>, <span class="va">theme_coords</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<div class="figure">
<img src="cc-spatial-measures_files/figure-html/unnamed-chunk-15-1.png" alt="Fig.6 Using SI units to specify algorithm input." width="50%"><img src="cc-spatial-measures_files/figure-html/unnamed-chunk-15-2.png" alt="Fig.6 Using SI units to specify algorithm input." width="50%"><p class="caption">
Fig.6 Using SI units to specify algorithm input.
</p>
</div>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># measuring distances </span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"spatial_trajectories"</span><span class="op">)</span>

<span class="va">object_t313_lowres</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="../reference/setTrajectory.html">setTrajectory</a></span><span class="op">(</span>
    object <span class="op">=</span> <span class="va">object_t313_lowres</span>, 
    trajectory <span class="op">=</span> <span class="va">spatial_trajectories</span><span class="op">[[</span><span class="st">"313_T"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"cross"</span><span class="op">]</span><span class="op">]</span>, 
    overwrite <span class="op">=</span> <span class="cn">TRUE</span>
    <span class="op">)</span>

<span class="va">trajectory_add_on</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="../reference/ggpLayerTrajectories.html">ggpLayerTrajectories</a></span><span class="op">(</span>
    object <span class="op">=</span> <span class="va">object_t313_lowres</span>, 
    ids <span class="op">=</span> <span class="st">"cross"</span>, 
    size <span class="op">=</span> <span class="fl">1.5</span>
  <span class="op">)</span>

<span class="va">necrotic_add_on</span> <span class="op">&lt;-</span>   
  <span class="fu"><a href="../reference/ggpLayerImgAnnOutline.html">ggpLayerImgAnnOutline</a></span><span class="op">(</span>
    object <span class="op">=</span> <span class="va">object_t313_lowres</span>, 
    ids <span class="op">=</span> <span class="st">"necrotic_center"</span>, 
    line_size <span class="op">=</span> <span class="fl">1</span>
  <span class="op">)</span>

<span class="fu"><a href="../reference/plotImageGgplot.html">plotImageGgplot</a></span><span class="op">(</span>
  object <span class="op">=</span> <span class="va">object_t313_lowres</span>, 
  unit <span class="op">=</span> <span class="st">"mm"</span>, 
  frame_by <span class="op">=</span> <span class="st">"coords"</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="va">necrotic_add_on</span> <span class="op">+</span> 
  <span class="va">trajectory_add_on</span> <span class="op">+</span>
  <span class="va">text_size</span></code></pre></div>
<div class="figure">
<img src="cc-spatial-measures_files/figure-html/unnamed-chunk-16-1.png" alt="Fig.7 Simplified distance measurement in real space." width="50%"><p class="caption">
Fig.7 Simplified distance measurement in real space.
</p>
</div>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># diameter necrotic center</span>
<span class="va">dm_nc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getTrajectoryLength.html">getTrajectoryLength</a></span><span class="op">(</span><span class="va">object_t313_lowres</span>, id <span class="op">=</span> <span class="st">"cross"</span>, unit <span class="op">=</span> <span class="st">"mm"</span><span class="op">)</span>

<span class="va">dm_nc</span>
<span class="co">## 3.106495 [mm]</span>

<span class="co"># always convertable</span>
<span class="fu"><a href="../reference/as_unit.html">as_pixel</a></span><span class="op">(</span><span class="va">dm_nc</span>, object <span class="op">=</span> <span class="va">object_t313_lowres</span><span class="op">)</span>
<span class="co">## [1] 177.7844</span>
<span class="co">## attr(,"unit")</span>
<span class="co">## [1] "px"</span>

<span class="fu"><a href="../reference/as_unit.html">as_micrometer</a></span><span class="op">(</span><span class="va">dm_nc</span><span class="op">)</span>
<span class="co">## 3106.495 [um]</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="working-with-areas">5. Working with areas<a class="anchor" aria-label="anchor" href="#working-with-areas"></a>
</h2>
<p>In addition to distances, areas can be computed, too. This becomes
interesting, for instance, if the area of an image annotation is of
relevance to the biological question.</p>
<div class="section level3">
<h3 id="handling-area-input-and-output">5.1 Handling area input and output<a class="anchor" aria-label="anchor" href="#handling-area-input-and-output"></a>
</h3>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/validActivationFunctions.html">validUnitsOfArea</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "nm2" "um2" "mm2" "cm2" "dm2" "m2"  "px"</span></code></pre>
<p>Pixel are by definition squares which means that all sides are of the
same length. This property is used in SPATA2 to use pixel as a unit of
distance. It can, however, be a unit of area, too. E.g. 4px with a side
length of 1um cover an area of 4um2 or an area of 4px. However, the
number of pixels that cover a specific area again depends on the
resolution of the image. Again, SPATA2 implements SI units of area.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/validActivationFunctions.html">validUnitsOfAreaSI</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "nm2" "um2" "mm2" "cm2" "dm2" "m2"</span></code></pre>
<p>Pixel is not among them. SPATA2 allows resolution dependent
conversion from pixel to SI units and vice versa. As pixel are squares
of equal sizes the scale factor used for distance conversion can be used
in its squared form.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/getPixelScaleFactor.html">getPixelScaleFactor</a></span><span class="op">(</span><span class="va">object_t313_lowres</span>, unit <span class="op">=</span> <span class="st">"um2"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 305.3193</span>
<span class="co">## attr(,"unit")</span>
<span class="co">## [1] "um2/px"</span></code></pre>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># fewer um2 per pixel in the high resolution object </span>
<span class="co"># -&gt; pixels are smaller</span>
<span class="fu"><a href="../reference/getPixelScaleFactor.html">getPixelScaleFactor</a></span><span class="op">(</span><span class="va">object_t313_highres</span>, unit <span class="op">=</span> <span class="st">"um2"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 19.08246</span>
<span class="co">## attr(,"unit")</span>
<span class="co">## [1] "um2/px"</span></code></pre>
<p>Functions that convert areas are named similar to those that convert
distances. If pixels are involved, the <code>SPATA2</code> object must
be specified as the scale factor is needed.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># numeric input is interpreted as pixel</span>
<span class="fu"><a href="../reference/as_unit.html">as_millimeter2</a></span><span class="op">(</span>input <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">200</span>, <span class="fl">400</span>, <span class="fl">4000</span>, <span class="fl">50000</span><span class="op">)</span>, object <span class="op">=</span> <span class="va">object_t313_lowres</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Units: [mm^2]</span>
<span class="co">## [1]  0.06106387  0.12212773  1.22127732 15.26596652</span></code></pre>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># if character, different units can be specified as input</span>
<span class="fu"><a href="../reference/as_unit.html">as_centimeter2</a></span><span class="op">(</span>input <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"4mm2"</span>, <span class="st">"400px"</span><span class="op">)</span>, object <span class="op">=</span> <span class="va">object_t313_lowres</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Units: [cm^2]</span>
<span class="co">## [1] 0.040000000 0.001221277</span></code></pre>
</div>
<div class="section level3">
<h3 id="examples-1">5.2 Examples<a class="anchor" aria-label="anchor" href="#examples-1"></a>
</h3>
<p>Compute the area that is covered by the tissue sample.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/getSampleAreaSize.html">getSampleAreaSize</a></span><span class="op">(</span><span class="va">object_t313_lowres</span>, unit <span class="op">=</span> <span class="st">"mm2"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## 30.69711 [mm^2]</span></code></pre>
<p>Compute the area that is covered by different image annotations and
filter accordingly.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># download sample</span>
<span class="va">object_t275_highres</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/downloadSpataObject.html">downloadSpataObject</a></span><span class="op">(</span>sample_name <span class="op">=</span> <span class="st">"275_T"</span><span class="op">)</span>

<span class="co"># set image annotations</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"image_annotations"</span><span class="op">)</span>

<span class="va">object_t275_highres</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="../reference/setImageAnnotation.html">setImageAnnotations</a></span><span class="op">(</span>
    object <span class="op">=</span> <span class="va">object_t275_highres</span>, 
    img_anns <span class="op">=</span> <span class="va">image_annotations</span><span class="op">[[</span><span class="st">"275_T"</span><span class="op">]</span><span class="op">]</span>, 
    overwrite <span class="op">=</span> <span class="cn">TRUE</span>
  <span class="op">)</span></code></pre></div>
<p>Distance and area information can be displayed with <a href="">scale
bars</a>. Additionally, the argument <code>expand</code> comes in handy
when it comes to extracting or visualizing image sections. Its input is
versatile: There is a whole section in the vignette <a href="">Image
handling</a> that elaborates on how to use the argument
<code>expand</code>.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plotImageAnnotations.html">plotImageAnnotations</a></span><span class="op">(</span>
  object <span class="op">=</span> <span class="va">object_t275_highres</span>,
  tags <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"vessel"</span>, <span class="st">"in_hypoxia"</span><span class="op">)</span>, 
  test <span class="op">=</span> <span class="st">"all"</span>,
  expand <span class="op">=</span> <span class="st">"400um!"</span>, <span class="co"># exclam input to fix x- and y-axis to 400um</span>
  square <span class="op">=</span> <span class="cn">TRUE</span>, 
  dist_sb <span class="op">=</span> <span class="st">"100um"</span>, <span class="co"># add distance scale bar </span>
  text_nudge_y <span class="op">=</span> <span class="st">"25um"</span>, 
  pos <span class="op">=</span> <span class="st">"bottom_right"</span>, 
  text_color <span class="op">=</span> <span class="st">"white"</span>,
  sgmt_color <span class="op">=</span> <span class="st">"white"</span>,
  ggpLayers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/ggpLayerAxesClean.html">ggpLayerAxesClean</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> 
<span class="op">)</span></code></pre></div>
<div class="figure">
<img src="cc-spatial-measures_files/figure-html/unnamed-chunk-24-1.png" alt="Fig.8 Image annotations whose area can be calculated." width="100%"><p class="caption">
Fig.8 Image annotations whose area can be calculated.
</p>
</div>
<p>Extracting the values can be used for further subsetting.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">img_ann_ids</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="../reference/getImgAnnIds.html">getImgAnnIds</a></span><span class="op">(</span>
    object <span class="op">=</span> <span class="va">object_t275_highres</span>,
    tags <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"vessel"</span>, <span class="st">"in_hypoxia"</span><span class="op">)</span>,
    test <span class="op">=</span> <span class="st">"all"</span>
    <span class="op">)</span>

<span class="va">img_ann_areas</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="../reference/getImgAnnArea.html">getImgAnnArea</a></span><span class="op">(</span>
    object <span class="op">=</span> <span class="va">object_t275_highres</span>,
    ids <span class="op">=</span> <span class="va">img_ann_ids</span>, 
    unit <span class="op">=</span> <span class="st">"um2"</span>
    <span class="op">)</span>

<span class="va">img_ann_areas</span></code></pre></div>
<pre><code><span class="co">## Units: [um^2]</span>
<span class="co">## img_ann_1 img_ann_2 img_ann_3 </span>
<span class="co">##  4951.661 13894.967  7461.176</span></code></pre>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># subset by annotations of a certain area</span>
<span class="va">threshold</span> <span class="op">&lt;-</span> <span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/units/man/units.html" class="external-link">set_units</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">7500</span>, value <span class="op">=</span> <span class="st">"um2"</span><span class="op">)</span>

<span class="va">img_ann_areas</span><span class="op">[</span><span class="va">img_ann_areas</span> <span class="op">&gt;</span> <span class="va">threshold</span><span class="op">]</span></code></pre></div>
<pre><code><span class="co">## 13894.97 [um^2]</span></code></pre>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Jan Kueckelhaus, Dieter-Henrik Heiland, Simon Frerich.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
