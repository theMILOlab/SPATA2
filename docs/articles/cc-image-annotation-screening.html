<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Image Annotation Screening - Code &amp; Concept • SPATA2</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Image Annotation Screening - Code &amp; Concept">
<meta property="og:description" content="SPATA2">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SPATA2</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/spata-v2-installation.html">Installation</a>
</li>
<li>
  <a href="../articles/spata-v2-spata-data.html">SPATAData</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Around the spata2 object</li>
    <li>
      <a href="../articles/spata-v2-object-initiation-and-manipulation.html">Object Set Up and Manipulation</a>
    </li>
    <li>
      <a href="../articles/spata-v2-platform-compatibility.html">Platform Compatibility</a>
    </li>
    <li>
      <a href="../articles/spata-v2-autoencoder.html">Autoencoder</a>
    </li>
    <li>
      <a href="../articles/spata-v2-genes-gene-sets-and-features.html">Genes, Gene Sets and Features</a>
    </li>
    <li class="dropdown-header">Image Analysis</li>
    <li>
      <a href="../articles/spata-v2-image-handling.html">Image Handling</a>
    </li>
    <li>
      <a href="../articles/spata-v2-image-annotations.html">Image Annotations</a>
    </li>
    <li>
      <a href="../articles/spata-v2-spatial-segmentation.html">Spatial Segmentation</a>
    </li>
    <li class="dropdown-header">Analysis of Gene Expression</li>
    <li>
      <a href="../articles/spata-v2-cnv-analysis.html">Copy Number Variations</a>
    </li>
    <li>
      <a href="../articles/spata-v2-clustering.html">Clustering</a>
    </li>
    <li>
      <a href="../articles/spata-v2-dea.html">Differential Expression</a>
    </li>
    <li>
      <a href="../articles/spata-v2-gsea.html">Gene Set Enrichment</a>
    </li>
    <li class="dropdown-header">Expression Gradients &amp; Gradient Screening</li>
    <li>
      <a href="../articles/spata-v2-spatial-trajectories.html">Spatial Trajectories</a>
    </li>
    <li>
      <a href="../articles/spata-v2-spatial-trajectory-screening.html">Spatial Trajectory Screening</a>
    </li>
    <li>
      <a href="../articles/spata-v2-image-annotation-screening.html">Image Annotation Screening</a>
    </li>
    <li>
      <a href="../articles/spata-v2-scd.html">Integrate Single Cell Deconvolution</a>
    </li>
    <li class="dropdown-header">Visualization</li>
    <li>
      <a href="../articles/spata-v2-plotting-surface.html">Surface Plotting</a>
    </li>
    <li>
      <a href="../articles/spata-v2-plotting-misc.html">Miscellaneous</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Code &amp; Concept
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/cc-spatial-measures.html">Spatial Measures</a>
    </li>
    <li>
      <a href="../articles/cc-spatial-segmentation-vs-image-annotations.html">Spatial Segmentation vs. Image Annotations</a>
    </li>
    <li>
      <a href="../articles/cc-spatial-trajectory-screening.html">Spatial Trajectory Screening</a>
    </li>
    <li>
      <a href="../articles/cc-image-annotation-screening.html">Image Annotation Screening</a>
    </li>
    <li>
      <a href="../articles/cc-model-fitting-in-spatial-transcriptomic-studies.html">Model Fitting</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Image Annotation Screening - Code &amp;
Concept</h1>
                        <h4 data-toc-skip class="author">Jan
Kueckelhaus</h4>
            
            <h4 data-toc-skip class="date">2022-08-20</h4>
      
      
      <div class="hidden name"><code>cc-image-annotation-screening.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="prerequisites">1. Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites"></a>
</h2>
<p>Make sure to be familiar with the following vignettes:</p>
<ul>
<li><a href="cc-spatial-segmentation-vs-image-annotations.html">Spatial
Segmentation vs. Image Annotations</a></li>
<li><a href="cc-image-annotations.html">Image Annotations</a></li>
</ul>
</div>
<div class="section level2">
<h2 id="introduction-overview">2. Introduction &amp; overview<a class="anchor" aria-label="anchor" href="#introduction-overview"></a>
</h2>
<p><em>Image Annotation Screening (IAS)</em> was developed to find genes
whose spatial expression stand in meaningful relation to histological
areas. It makes use of <strong>SPATA2’s</strong> inbuilt image
annotation system that allows to highlight and integrate the spatial
extent of areas of interest in the analysis in form of image
annotations. This vignette explains the concept of the IAS-algorithm
step by step and provides code chunks needed to reproduce the
results.</p>
<p>The algorithm can be divided in three parts.</p>
<ul>
<li>1.) Binning barcode-spots depending on their distance to the
annotated area.</li>
<li>2.) Inferring gene expression changes as a function of distance to
the image annotation.</li>
<li>3.) Screening gene expression changes for biologically interesting
behaviors by fitting the changes against predefined models.</li>
</ul>
<p>Here, all steps of part 1.) and 2.) of the algorithm are shown. Part
3.) is explained in the tutorial on <a href="">Model fitting in spatial
transcriptomic studies</a>.</p>
<p>As an example we are using a spatial transcriptomic sample of a
glioblastoma that features a prominent necrotic area in it’s center.
This area has been annotated with <code><a href="../reference/createImageAnnotations.html">createImageAnnotations()</a></code>.
To reproduce the results of this vignette you can either create the
image annotation yourself or add it with the code you find below.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://themilolab.com/" class="external-link">SPATA2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">SPATAData</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span>

<span class="va">object_t313</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/downloadSpataObject.html">downloadSpataObject</a></span><span class="op">(</span>sample_name <span class="op">=</span> <span class="st">"313_T"</span><span class="op">)</span>

<span class="co"># create the image annotation interactively</span>
<span class="va">object_t313</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createImageAnnotations.html">createImageAnnotations</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">object_t313</span><span class="op">)</span>

<span class="co"># or set the example annotation</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"image_annotations"</span><span class="op">)</span>

<span class="va">object_t313</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="../reference/setImageAnnotation.html">setImageAnnotation</a></span><span class="op">(</span>
    object <span class="op">=</span> <span class="va">object_t313</span>,
    img_ann <span class="op">=</span> <span class="va">image_annotations</span><span class="op">[[</span><span class="st">"313_T"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"necrotic_center"</span><span class="op">]</span><span class="op">]</span>, 
    overwrite <span class="op">=</span> <span class="cn">TRUE</span>
  <span class="op">)</span>

<span class="va">necrotic_area</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="../reference/ggpLayerImgAnnOutline.html">ggpLayerImgAnnOutline</a></span><span class="op">(</span>
    object <span class="op">=</span> <span class="va">object_t313</span>,
    ids <span class="op">=</span> <span class="st">"necrotic_center"</span>,
    line_size <span class="op">=</span> <span class="fl">1</span>, 
    alpha <span class="op">=</span> <span class="fl">0.1</span>, 
    fill <span class="op">=</span> <span class="st">"orange"</span>
  <span class="op">)</span>

<span class="co"># extract the polygon data.frame that contains</span>
<span class="co"># information of the area of the image annotation</span>
<span class="va">area_df</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="../reference/getImgAnnOutlineDf.html">getImgAnnOutlineDf</a></span><span class="op">(</span>
    object <span class="op">=</span> <span class="va">object_t313</span>,
    ids <span class="op">=</span> <span class="st">"necrotic_center"</span>
  <span class="op">)</span>

<span class="va">rectangular</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="../reference/ggpLayerRect.html">ggpLayerRect</a></span><span class="op">(</span>
    object <span class="op">=</span> <span class="va">object_t313</span>,
    xrange <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">area_df</span><span class="op">[[</span><span class="st">"x"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,
    yrange <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">area_df</span><span class="op">[[</span><span class="st">"y"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, 
    expand <span class="op">=</span> <span class="fl">0.05</span>
  <span class="op">)</span>

<span class="co"># plot results</span>
<span class="fu"><a href="../reference/plotImageGgplot.html">plotImageGgplot</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">object_t313</span><span class="op">)</span> <span class="op">+</span> 
  <span class="va">rectangular</span> <span class="op">+</span> 
  <span class="va">necrotic_area</span>

<span class="fu"><a href="../reference/plotImageAnnotations.html">plotImageAnnotations</a></span><span class="op">(</span>
  object <span class="op">=</span> <span class="va">object_t313</span>,
  ids <span class="op">=</span> <span class="st">"necrotic_center"</span>,
  expand <span class="op">=</span> <span class="fl">0.05</span>, 
  line_size <span class="op">=</span> <span class="fl">1</span>,
  alpha <span class="op">=</span> <span class="fl">0</span>,
  display_caption <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span></code></pre></div>
<p><img src="cc-image-annotation-screening_files/figure-html/load-session-1.png" width="50%"><img src="cc-image-annotation-screening_files/figure-html/load-session-2.png" width="50%"></p>
</div>
<div class="section level2">
<h2 id="image-annotation-screening-step-by-step">3. Image annotation screening step by step<a class="anchor" aria-label="anchor" href="#image-annotation-screening-step-by-step"></a>
</h2>
<div class="section level3">
<h3 id="binning-barcode-spots-depending-on-their-distance-to-the-image-annotation-">3.1 Binning barcode-spots depending on their distance to the image
annotation.<a class="anchor" aria-label="anchor" href="#binning-barcode-spots-depending-on-their-distance-to-the-image-annotation-"></a>
</h3>
<p>The process of binning barcode-spots according to their distance to
the image annotation can be splitted in two steps:</p>
<ul>
<li><ol style="list-style-type: decimal">
<li>Obtain information about the borders of the image annotation.</li>
</ol></li>
<li><ol start="2" style="list-style-type: decimal">
<li>Expand the borders of the image annotation repeatedly to
consecutively bin the barcode-spots depending on the number of
expansions necessary to reach them.</li>
</ol></li>
</ul>
<div class="section level4">
<h4 id="obtain-information-about-the-borders-of-the-image-annotation">3.1.1 Obtain information about the borders of the image
annotation<a class="anchor" aria-label="anchor" href="#obtain-information-about-the-borders-of-the-image-annotation"></a>
</h4>
<p>Mapping the x- and y-coordinates of the barcode-spots to the
respective x- and y-aesthetics results in a basic surface plot.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># table on the right</span>
<span class="va">coords_df</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="../reference/getCoordsDf.html">getCoordsDf</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">object_t313</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">sample</span><span class="op">)</span>

<span class="va">theme_add_on</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>
    panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>, 
    panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
    axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>
  <span class="op">)</span>

<span class="co"># plot on the left</span>
<span class="va">surface_plot</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">coords_df</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"lightgrey"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_equal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="va">theme_add_on</span></code></pre></div>
<div class="row">
<div class="col-md-6">
<p><img src="cc-image-annotation-screening_files/figure-html/unnamed-chunk-3-1.png" width="100%"></p>
</div>
<div class="col-md-6">
<pre><code><span class="co">## <span style="color: #949494;"># A tibble: 3,517 x 5</span></span>
<span class="co">##    barcodes               x     y section outline</span>
<span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>  </span>
<span class="co">## <span style="color: #BCBCBC;"> 1</span> AAACAAGTATCTCCCA-1 <span style="text-decoration: underline;">1</span>456. <span style="text-decoration: underline;">1</span>241. 1       FALSE  </span>
<span class="co">## <span style="color: #BCBCBC;"> 2</span> AAACAATCTACTAGCA-1  781.  309. 1       FALSE  </span>
<span class="co">## <span style="color: #BCBCBC;"> 3</span> AAACACCAATAACTGC-1  509. <span style="text-decoration: underline;">1</span>421. 1       FALSE  </span>
<span class="co">## <span style="color: #BCBCBC;"> 4</span> AAACAGAGCGACTCCT-1 <span style="text-decoration: underline;">1</span>364.  527. 1       FALSE  </span>
<span class="co">## <span style="color: #BCBCBC;"> 5</span> AAACAGCTTTCAGAAG-1  394. <span style="text-decoration: underline;">1</span>104. 1       FALSE  </span>
<span class="co">## <span style="color: #BCBCBC;"> 6</span> AAACAGGGTCTATATT-1  440. <span style="text-decoration: underline;">1</span>183. 1       FALSE  </span>
<span class="co">## <span style="color: #BCBCBC;"> 7</span> AAACATGGTGAGAGGA-1  292. <span style="text-decoration: underline;">1</span>481. 1       TRUE   </span>
<span class="co">## <span style="color: #BCBCBC;"> 8</span> AAACCCGAACGAAATC-1 <span style="text-decoration: underline;">1</span>604. <span style="text-decoration: underline;">1</span>142. 1       FALSE  </span>
<span class="co">## <span style="color: #BCBCBC;"> 9</span> AAACCGGGTAGGTACC-1  611. <span style="text-decoration: underline;">1</span>084. 1       FALSE  </span>
<span class="co">## <span style="color: #BCBCBC;">10</span> AAACCGTTCGTCCAGG-1  771. <span style="text-decoration: underline;">1</span>282. 1       FALSE  </span>
<span class="co">## <span style="color: #949494;"># i 3,507 more rows</span></span></code></pre>
</div>
</div>
<p>The area of an image annotation is circumscribed by a polygon that is
created during the drawing process in
<code><a href="../reference/createImageAnnotations.html">createImageAnnotations()</a></code> where every few milliseconds the
position of the cursor is stored in a data.frame. The corresponding
data.frame can be extracted with <code><a href="../reference/getImgAnnOutlineDf.html">getImgAnnOutlineDf()</a></code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># table on the right</span>
<span class="va">area_df</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="../reference/getImgAnnOutlineDf.html">getImgAnnOutlineDf</a></span><span class="op">(</span>
    object <span class="op">=</span> <span class="va">object_t313</span>,
    ids <span class="op">=</span> <span class="st">"necrotic_center"</span>
    <span class="op">)</span>

<span class="co"># save image annotation layer</span>
<span class="va">necrotic_area</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_polygon.html" class="external-link">geom_polygon</a></span><span class="op">(</span>
    data <span class="op">=</span> <span class="va">area_df</span>, 
    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, group <span class="op">=</span> <span class="va">ids</span><span class="op">)</span>, 
    size <span class="op">=</span> <span class="fl">1</span>, 
    fill <span class="op">=</span> <span class="cn">NA</span>, 
    color <span class="op">=</span> <span class="st">"black"</span>
  <span class="op">)</span>

<span class="co"># plot results on the left</span>
<span class="va">surface_plot</span> <span class="op">+</span> 
  <span class="va">necrotic_area</span></code></pre></div>
<div class="row">
<div class="col-md-6">
<p><img src="cc-image-annotation-screening_files/figure-html/unnamed-chunk-7-1.png" width="100%"></p>
</div>
<div class="col-md-6">
<pre><code><span class="co">## <span style="color: #949494;"># A tibble: 286 x 4</span></span>
<span class="co">##    ids             border     x     y</span>
<span class="co">##    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;"> 1</span> necrotic_center outer   512. <span style="text-decoration: underline;">1</span>378.</span>
<span class="co">## <span style="color: #BCBCBC;"> 2</span> necrotic_center outer   512. <span style="text-decoration: underline;">1</span>363.</span>
<span class="co">## <span style="color: #BCBCBC;"> 3</span> necrotic_center outer   510. <span style="text-decoration: underline;">1</span>354.</span>
<span class="co">## <span style="color: #BCBCBC;"> 4</span> necrotic_center outer   505. <span style="text-decoration: underline;">1</span>350.</span>
<span class="co">## <span style="color: #BCBCBC;"> 5</span> necrotic_center outer   505. <span style="text-decoration: underline;">1</span>347.</span>
<span class="co">## <span style="color: #BCBCBC;"> 6</span> necrotic_center outer   500. <span style="text-decoration: underline;">1</span>341.</span>
<span class="co">## <span style="color: #BCBCBC;"> 7</span> necrotic_center outer   498. <span style="text-decoration: underline;">1</span>334.</span>
<span class="co">## <span style="color: #BCBCBC;"> 8</span> necrotic_center outer   498. <span style="text-decoration: underline;">1</span>330.</span>
<span class="co">## <span style="color: #BCBCBC;"> 9</span> necrotic_center outer   498. <span style="text-decoration: underline;">1</span>323.</span>
<span class="co">## <span style="color: #BCBCBC;">10</span> necrotic_center outer   500. <span style="text-decoration: underline;">1</span>312.</span>
<span class="co">## <span style="color: #949494;"># i 276 more rows</span></span></code></pre>
</div>
</div>
<p>Depending on the input for argument <code>include_area</code>, IAS
included the area of the annotatio itself or only screens the
<strong>surrounding</strong> of the image annotation. Here, we only
screen the surrounding. Therefore, the barcode-spots that fall in the
area of the image annotation can be removed.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># create variable that contains information about</span>
<span class="co"># the position of all barcode-spots in relation to </span>
<span class="co"># the image annotation area</span>
<span class="va">coords_df</span><span class="op">$</span><span class="va">pt_in_plg</span> <span class="op">&lt;-</span>
  <span class="fu">sp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/point.in.polygon.html" class="external-link">point.in.polygon</a></span><span class="op">(</span>
    point.x <span class="op">=</span> <span class="va">coords_df</span><span class="op">$</span><span class="va">x</span>,
    point.y <span class="op">=</span> <span class="va">coords_df</span><span class="op">$</span><span class="va">y</span>,
    pol.x <span class="op">=</span> <span class="va">area_df</span><span class="op">$</span><span class="va">x</span>,
    pol.y <span class="op">=</span> <span class="va">area_df</span><span class="op">$</span><span class="va">y</span>
  <span class="op">)</span>

<span class="co"># remove barcode-spots that lie inside the polygon</span>
<span class="va">filtered_coords_df</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">coords_df</span>, <span class="op">!</span><span class="va">pt_in_plg</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>

<span class="va">ias_surface_plot</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">filtered_coords_df</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"lightgrey"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_equal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="va">theme_add_on</span>

<span class="va">ias_surface_plot</span> <span class="op">+</span> 
  <span class="va">necrotic_area</span> </code></pre></div>
<p><img src="cc-image-annotation-screening_files/figure-html/add_polygon-1.png" width="50%"></p>
</div>
<div class="section level4">
<h4 id="bin-barcode-spots-by-consecutive-expansion-of-the-area">3.1.2 Bin barcode-spots by consecutive expansion of the area<a class="anchor" aria-label="anchor" href="#bin-barcode-spots-by-consecutive-expansion-of-the-area"></a>
</h4>
<p>The package <code>sf</code> provides the functions
<code>st_polygon()</code> and <code>st_buffer()</code> that can be used
to expand the area. To sort the barcode-spots in the corresponding bins,
the function <code><a href="https://rdrr.io/pkg/sp/man/point.in.polygon.html" class="external-link">sp::point.in.polygon()</a></code> is used to label
them.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># plot on the LEFT ----------</span>

<span class="co"># add first row as the last row to "close" the area</span>
<span class="co"># required by st_polygon()</span>
<span class="va">closed_area_df</span> <span class="op">&lt;-</span> <span class="va">area_df</span>

<span class="va">closed_area_df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">closed_area_df</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">closed_area_df</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span>

<span class="va">binwidth</span> <span class="op">&lt;-</span> <span class="st">"0.2mm"</span>

<span class="va">binwidth</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_unit.html">as_pixel</a></span><span class="op">(</span><span class="va">binwidth</span>, object <span class="op">=</span> <span class="va">object_t313</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">binwidth</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 45.78391</span>
<span class="co">## attr(,"unit")</span>
<span class="co">## [1] "px"</span></code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># grow by a buffer 20 </span>
<span class="va">area_df_grown20</span> <span class="op">&lt;-</span>
  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html" class="external-link">st_polygon</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">closed_area_df</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_buffer</a></span><span class="op">(</span>dist <span class="op">=</span> <span class="va">binwidth</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># &lt;- grows/buffers the polygon</span>
  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu">magrittr</span><span class="fu">::</span><span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html" class="external-link">set_colnames</a></span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>ids <span class="op">=</span> <span class="st">"necrotic_center"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># grow by a buffer of 40</span>
<span class="va">area_df_grown40</span> <span class="op">&lt;-</span>
  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html" class="external-link">st_polygon</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">closed_area_df</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_buffer</a></span><span class="op">(</span>dist <span class="op">=</span> <span class="op">(</span><span class="va">binwidth</span><span class="op">*</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># &lt;- grows/buffers the polygon</span>
  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu">magrittr</span><span class="fu">::</span><span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html" class="external-link">set_colnames</a></span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>ids <span class="op">=</span> <span class="st">"necrotic_center"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">necrotic_area_grown20</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_polygon.html" class="external-link">geom_polygon</a></span><span class="op">(</span>
    data <span class="op">=</span> <span class="va">area_df_grown20</span>, 
    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, group <span class="op">=</span> <span class="va">ids</span><span class="op">)</span>, 
    size <span class="op">=</span> <span class="fl">1</span>, 
    fill <span class="op">=</span> <span class="cn">NA</span>, 
    color <span class="op">=</span> <span class="st">"red"</span>
  <span class="op">)</span>

<span class="va">necrotic_area_grown40</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_polygon.html" class="external-link">geom_polygon</a></span><span class="op">(</span>
    data <span class="op">=</span> <span class="va">area_df_grown40</span>, 
    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, group <span class="op">=</span> <span class="va">ids</span><span class="op">)</span>, 
    size <span class="op">=</span> <span class="fl">1</span>, 
    fill <span class="op">=</span> <span class="cn">NA</span>, 
    color <span class="op">=</span> <span class="st">"blue"</span>
  <span class="op">)</span>

<span class="va">plot_area_expansion</span> <span class="op">&lt;-</span> 
  <span class="va">ias_surface_plot</span> <span class="op">+</span> 
  <span class="va">necrotic_area</span> <span class="op">+</span> 
  <span class="va">necrotic_area_grown20</span> <span class="op">+</span> 
  <span class="va">necrotic_area_grown40</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>subtitle <span class="op">=</span> <span class="st">"a) Area expansion"</span><span class="op">)</span>

<span class="co"># -----</span>
  

<span class="co"># plot on the RIGHT ----------</span>
<span class="va">area_list</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
    <span class="st">"Circle 1"</span> <span class="op">=</span> <span class="va">area_df_grown20</span>, 
    <span class="st">"Circle 2"</span> <span class="op">=</span> <span class="va">area_df_grown40</span>
  <span class="op">)</span>

<span class="va">filtered_coords_df</span><span class="op">$</span><span class="va">bins_circle</span> <span class="op">&lt;-</span> <span class="st">"Outside"</span>

<span class="co"># iterate over list names (Circle 1, Circle 2)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">expansion</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">area_list</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  
  <span class="va">area_df_expanded</span> <span class="op">&lt;-</span> <span class="va">area_list</span><span class="op">[[</span><span class="va">expansion</span><span class="op">]</span><span class="op">]</span>
  
  <span class="va">filtered_coords_df</span><span class="op">$</span><span class="va">pt_in_plg</span> <span class="op">&lt;-</span> 
    <span class="fu">sp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/point.in.polygon.html" class="external-link">point.in.polygon</a></span><span class="op">(</span>
      point.x <span class="op">=</span> <span class="va">filtered_coords_df</span><span class="op">$</span><span class="va">x</span>, 
      point.y <span class="op">=</span> <span class="va">filtered_coords_df</span><span class="op">$</span><span class="va">y</span>, 
      pol.x <span class="op">=</span> <span class="va">area_df_expanded</span><span class="op">$</span><span class="va">x</span>,
      pol.y <span class="op">=</span> <span class="va">area_df_expanded</span><span class="op">$</span><span class="va">y</span>
    <span class="op">)</span>
  
  <span class="va">filtered_coords_df</span> <span class="op">&lt;-</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>
      .data <span class="op">=</span> <span class="va">filtered_coords_df</span>, 
      bins_circle <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span>
          <span class="co"># if bins_circle is NOT 'Outside' it has already bin binned by previous expansions</span>
        <span class="co"># label with `expansion` (which is either 'Circle 1' or 'Circle 2')</span>
        <span class="va">bins_circle</span> <span class="op">==</span> <span class="st">"Outside"</span> <span class="op">&amp;</span> <span class="va">pt_in_plg</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span> <span class="op">~</span> <span class="op">{</span><span class="op">{</span><span class="va">expansion</span><span class="op">}</span><span class="op">}</span>,
        <span class="co"># else keep label </span>
        <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">bins_circle</span>
      <span class="op">)</span>
    <span class="op">)</span>
  
<span class="op">}</span>

<span class="va">plot_binned</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">filtered_coords_df</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">bins_circle</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>
    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>
      <span class="st">"Outside"</span> <span class="op">=</span> <span class="st">"lightgrey"</span>,
      <span class="st">"Circle 1"</span> <span class="op">=</span> <span class="st">"red"</span>, 
      <span class="st">"Circle 2"</span> <span class="op">=</span> <span class="st">"blue"</span>
    <span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_equal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="va">theme_add_on</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>subtitle <span class="op">=</span> <span class="st">"b) Binned"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="../reference/legendBottom.html">legendNone</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># -----</span>
  
<span class="va">plot_area_expansion</span>
<span class="va">plot_binned</span></code></pre></div>
<p><img src="cc-image-annotation-screening_files/figure-html/unnamed-chunk-9-1.png" width="50%"><img src="cc-image-annotation-screening_files/figure-html/unnamed-chunk-9-2.png" width="50%"></p>
<p>How the binning is conducted and the screening is configurated
depends on a few parameters. The two most important ones are:</p>
<ul>
<li><ol style="list-style-type: decimal">
<li>
<code>distance</code>: The distance from the border of the image
annotation to the <em>horizon</em> in the periphery up to which the
screening is conducted.</li>
</ol></li>
<li><ol start="2" style="list-style-type: decimal">
<li>
<code>binwidth</code>: The binwidth of every bin created as
displayed above.</li>
</ol></li>
</ul>
<p>Both, <code>distance</code> and <code>binwidth</code> are distance
measures and can be specified in pixel or in SI units. We recommend SI
units as it makes the scripts reproducible in case of changing image
resolutions. See our vignette on <a href="cc-spatial-measures.html">spatial measures in SPATA2</a> for more
information about SI units are handled.</p>
<p>The function <code><a href="../reference/plotSurfaceIAS.html">plotSurfaceIAS()</a></code> allows to visualize the
IAS setup. The binwidth of the example above has been set to 20 for
visualization purposes. By default the IAS-algorithm uses a binwidth
that is equal to the distance between the barcode-spots. This results in
bins that include one layer of barcode-spots each.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># using the center to center distance of barcodes as a binwidth</span>
<span class="va">bcsp_dist</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getCCD.html">getCCD</a></span><span class="op">(</span><span class="va">object_t313</span><span class="op">)</span>

<span class="co"># show results</span>
<span class="va">bcsp_dist</span></code></pre></div>
<pre><code><span class="co">## 100 [um]</span></code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">plist</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="../reference/plotSurfaceIAS.html">plotSurfaceIAS</a></span><span class="op">(</span>
    object <span class="op">=</span> <span class="va">object_t313</span>,
    id <span class="op">=</span> <span class="st">"necrotic_center"</span>,
    distance <span class="op">=</span> <span class="st">"2mm"</span>, 
    pt_clrp <span class="op">=</span> <span class="st">"milo"</span>, <span class="co"># use colorful palette to highlight the bins</span>
    binwidth <span class="op">=</span> <span class="va">bcsp_dist</span>, 
    ggpLayer <span class="op">=</span> <span class="fu"><a href="../reference/ggpLayerThemeCoords.html">ggpLayerThemeCoords</a></span><span class="op">(</span><span class="op">)</span>,
    show_plots <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span>

<span class="va">plist2</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="../reference/plotSurfaceIAS.html">plotSurfaceIAS</a></span><span class="op">(</span>
    object <span class="op">=</span> <span class="va">object_t313</span>,
    id <span class="op">=</span> <span class="st">"necrotic_center"</span>,
    distance <span class="op">=</span> <span class="st">"2mm"</span>, 
    pt_clrp <span class="op">=</span> <span class="st">"inferno"</span>, <span class="co"># use continuos palette to highlight the 'direction'</span>
    binwidth <span class="op">=</span> <span class="va">bcsp_dist</span>, 
    ggpLayer <span class="op">=</span> <span class="fu"><a href="../reference/ggpLayerThemeCoords.html">ggpLayerThemeCoords</a></span><span class="op">(</span><span class="op">)</span>,
    show_plots <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span>

<span class="co"># plot results </span>
<span class="va">plist</span><span class="op">$</span><span class="va">bins_circle</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>subtitle <span class="op">=</span> <span class="st">"a) Colorful"</span><span class="op">)</span>

<span class="va">plist2</span><span class="op">$</span><span class="va">bins_circle</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>subtitle <span class="op">=</span> <span class="st">"b) Continuous"</span><span class="op">)</span></code></pre></div>
<p><img src="cc-image-annotation-screening_files/figure-html/unnamed-chunk-10-1.png" width="50%"><img src="cc-image-annotation-screening_files/figure-html/unnamed-chunk-10-2.png" width="50%"></p>
<p>The number of bins created this way is expressed in the function:
<span class="math inline">\(n.bins.circle =
\frac{distance}{binwidth}\)</span></p>
<p>It is possible to specify <code>n_bins_circle</code> which makes it
the third argument that can be used to adjust the screening.</p>
<ul>
<li><ol start="3" style="list-style-type: decimal">
<li>
<code>n_bins_circle</code>: The number of bins created within the
range from the image annotations border till the <em>horizon</em> where
the screening stops.</li>
</ol></li>
</ul>
<p>If so, either <code>distance</code> or <code>binwidth</code> must
<strong>not</strong> be specified because the third parameter is always
calculated according to the first and the second one. Accordingly, the
relation between the arguments stays the same regardless of which
argument is not specified.</p>
<p>If <code>distance</code> is not specified: <span class="math inline">\(distance = binwidth * n.bins.circle\)</span></p>
<p>If <code>binwidth</code> is not specified: <span class="math inline">\(binwidth =
\frac{distance}{n.bins.circle}\)</span></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># n_bins_circle = 20</span>
<span class="co"># binwidth = 100um</span>
<span class="co"># distance = n_bins_circle * binwidth = 20 * 100um = 2000um = 2mm</span>

<span class="va">plist3</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="../reference/plotSurfaceIAS.html">plotSurfaceIAS</a></span><span class="op">(</span>
    object <span class="op">=</span> <span class="va">object_t313</span>,
    id <span class="op">=</span> <span class="st">"necrotic_center"</span>,
    n_bins_circle <span class="op">=</span> <span class="fl">20</span>,
    binwidth <span class="op">=</span> <span class="va">bcsp_dist</span>, 
    distance <span class="op">=</span> <span class="cn">NA_integer_</span>, <span class="co"># NA as n_bins_circle and binwidth were specified</span>
    ggpLayer <span class="op">=</span> <span class="fu"><a href="../reference/ggpLayerThemeCoords.html">ggpLayerThemeCoords</a></span><span class="op">(</span><span class="op">)</span>,
    show_plots <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span>

<span class="co"># plot results</span>
<span class="va">plist3</span><span class="op">$</span><span class="va">bins_circle</span></code></pre></div>
<p><img src="cc-image-annotation-screening_files/figure-html/n_bins_circle-1.png" width="50%"></p>
</div>
</div>
<div class="section level3">
<h3 id="inferring-gene-expression-changes">3.2 Inferring gene expression changes<a class="anchor" aria-label="anchor" href="#inferring-gene-expression-changes"></a>
</h3>
<p>The code to expand the area above is wrapped up inside the helper
function <code><a href="../reference/bin_by_expansion.html">bin_by_expansion()</a></code>. The binning can be displayed
in form of surface plots.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># distance of 3.3mm covers the whole extent of the sample </span>
<span class="va">distance</span> <span class="op">&lt;-</span> <span class="st">"3.3mm"</span>

<span class="co"># convert to pixel</span>
<span class="va">distance</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_unit.html">as_pixel</a></span><span class="op">(</span><span class="va">distance</span>, object <span class="op">=</span> <span class="va">object_t313</span><span class="op">)</span>
<span class="va">bcsp_dist</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_unit.html">as_pixel</a></span><span class="op">(</span><span class="va">bcsp_dist</span>, object <span class="op">=</span> <span class="va">object_t313</span><span class="op">)</span>

<span class="va">distance</span></code></pre></div>
<pre><code><span class="co">## [1] 755.4344</span>
<span class="co">## attr(,"unit")</span>
<span class="co">## [1] "px"</span></code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bcsp_dist</span></code></pre></div>
<pre><code><span class="co">## [1] 22.89195</span>
<span class="co">## attr(,"unit")</span>
<span class="co">## [1] "px"</span></code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># round up with ceiling()</span>
<span class="va">n_bins</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="va">distance</span><span class="op">/</span><span class="va">bcsp_dist</span><span class="op">)</span>

<span class="co"># show results </span>
<span class="va">n_bins</span> </code></pre></div>
<pre><code><span class="co">## [1] 33</span>
<span class="co">## attr(,"unit")</span>
<span class="co">## [1] "px"</span></code></pre>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">binned_coords</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="../reference/bin_by_expansion.html">bin_by_expansion</a></span><span class="op">(</span>
    coords_df <span class="op">=</span> <span class="va">coords_df</span>, <span class="co"># the coordinates of the barcode spots</span>
    area_df <span class="op">=</span> <span class="va">area_df</span>, <span class="co"># the polygon that encircles the area of interest</span>
    binwidth <span class="op">=</span> <span class="va">bcsp_dist</span>,
    n_bins_circle <span class="op">=</span> <span class="va">n_bins</span> <span class="co"># n_bins = 30</span>
  <span class="op">)</span>

<span class="co"># show results</span>
<span class="va">binned_coords</span></code></pre></div>
<pre><code><span class="co">## <span style="color: #949494;"># A tibble: 3,517 x 8</span></span>
<span class="co">##    barcodes               x     y section outline bins_circle border bins_order</span>
<span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;"> 1</span> AAACAGGGTCTATATT-1  440. <span style="text-decoration: underline;">1</span>183. 1       FALSE   Core        outer           0</span>
<span class="co">## <span style="color: #BCBCBC;"> 2</span> AAACCGGGTAGGTACC-1  611. <span style="text-decoration: underline;">1</span>084. 1       FALSE   Core        outer           0</span>
<span class="co">## <span style="color: #BCBCBC;"> 3</span> AAACCGTTCGTCCAGG-1  771. <span style="text-decoration: underline;">1</span>282. 1       FALSE   Core        outer           0</span>
<span class="co">## <span style="color: #BCBCBC;"> 4</span> AAACCTCATGAAGTTG-1  508.  985. 1       FALSE   Core        outer           0</span>
<span class="co">## <span style="color: #BCBCBC;"> 5</span> AAACTTGCAAACGTAT-1  509. <span style="text-decoration: underline;">1</span>143. 1       FALSE   Core        outer           0</span>
<span class="co">## <span style="color: #BCBCBC;"> 6</span> AAAGGCTACGGACCAT-1  908. <span style="text-decoration: underline;">1</span>480. 1       FALSE   Core        outer           0</span>
<span class="co">## <span style="color: #BCBCBC;"> 7</span> AAAGGCTCTCGCGCCG-1  920. <span style="text-decoration: underline;">1</span>341. 1       FALSE   Core        outer           0</span>
<span class="co">## <span style="color: #BCBCBC;"> 8</span> AAAGGGCAGCTTGAAT-1  588.  727. 1       FALSE   Core        outer           0</span>
<span class="co">## <span style="color: #BCBCBC;"> 9</span> AAAGTAGCATTGCTCA-1  600. <span style="text-decoration: underline;">1</span>262. 1       FALSE   Core        outer           0</span>
<span class="co">## <span style="color: #BCBCBC;">10</span> AAATCGTGTACCACAA-1  931. <span style="text-decoration: underline;">1</span>123. 1       FALSE   Core        outer           0</span>
<span class="co">## <span style="color: #949494;"># i 3,507 more rows</span></span></code></pre>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># a distance of 200 spans the whole sample</span>
<span class="va">plot_binned</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="../reference/plotSurface.html">plotSurface</a></span><span class="op">(</span>
    object <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">binned_coords</span>, <span class="va">bins_circle</span> <span class="op">!=</span> <span class="st">"Core"</span><span class="op">)</span>,
    color_by <span class="op">=</span> <span class="st">"bins_circle"</span>,
    pt_clrp <span class="op">=</span> <span class="st">"inferno"</span>
  <span class="op">)</span>

<span class="co"># plot results</span>
<span class="va">plot_binned</span></code></pre></div>
<p><img src="cc-image-annotation-screening_files/figure-html/unnamed-chunk-11-1.png" width="50%"></p>
<p>By summarizing the gene expression by these circular bins the gene
expression changes in relation to the distance to the area of interest
can be inferred and linearly displayed. To achieve that, the genes of
interest are joined to the data.frame that contains the binning
information.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># example genes</span>
<span class="va">genes_of_interest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"FN1"</span>, <span class="st">"MYL6"</span>, <span class="st">"MCTS1"</span><span class="op">)</span>

<span class="va">joined_df</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="../reference/joinWith.html">joinWithGenes</a></span><span class="op">(</span>
    object <span class="op">=</span> <span class="va">object_t313</span>, 
    spata_df <span class="op">=</span> <span class="va">binned_coords</span>, 
    genes <span class="op">=</span> <span class="va">genes_of_interest</span>
  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">x</span>, <span class="op">-</span><span class="va">y</span><span class="op">)</span> <span class="co"># not needed any longer</span>

<span class="co"># show results </span>
<span class="va">joined_df</span></code></pre></div>
<pre><code><span class="co">## <span style="color: #949494;"># A tibble: 3,517 x 9</span></span>
<span class="co">##    barcodes      section outline bins_circle border bins_order   FN1  MYL6 MCTS1</span>
<span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;"> 1</span> AAACAGGGTCTA~ 1       FALSE   Core        outer           0 0.811 0         0</span>
<span class="co">## <span style="color: #BCBCBC;"> 2</span> AAACCGGGTAGG~ 1       FALSE   Core        outer           0 0     0         0</span>
<span class="co">## <span style="color: #BCBCBC;"> 3</span> AAACCGTTCGTC~ 1       FALSE   Core        outer           0 0.716 0         0</span>
<span class="co">## <span style="color: #BCBCBC;"> 4</span> AAACCTCATGAA~ 1       FALSE   Core        outer           0 0.570 0         0</span>
<span class="co">## <span style="color: #BCBCBC;"> 5</span> AAACTTGCAAAC~ 1       FALSE   Core        outer           0 0.447 0.694     0</span>
<span class="co">## <span style="color: #BCBCBC;"> 6</span> AAAGGCTACGGA~ 1       FALSE   Core        outer           0 0.813 0.257     0</span>
<span class="co">## <span style="color: #BCBCBC;"> 7</span> AAAGGCTCTCGC~ 1       FALSE   Core        outer           0 0.646 0.195     0</span>
<span class="co">## <span style="color: #BCBCBC;"> 8</span> AAAGGGCAGCTT~ 1       FALSE   Core        outer           0 0.531 0.366     0</span>
<span class="co">## <span style="color: #BCBCBC;"> 9</span> AAAGTAGCATTG~ 1       FALSE   Core        outer           0 0.441 0         0</span>
<span class="co">## <span style="color: #BCBCBC;">10</span> AAATCGTGTACC~ 1       FALSE   Core        outer           0 0.648 0         0</span>
<span class="co">## <span style="color: #949494;"># i 3,507 more rows</span></span></code></pre>
<p>Summarizing the genes by bin and shifting the perspective allows to
plot the three genes along the variable <em>bins_circle</em> and to
display the gene expression as a function of distance to the necrotic
area.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">smrd_df</span> <span class="op">&lt;-</span> 
  <span class="co"># group barcode-spots by bin</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">joined_df</span>, <span class="va">bins_circle</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="co"># summarize gene expression</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span>
      .cols <span class="op">=</span> <span class="op">{</span><span class="op">{</span><span class="va">genes_of_interest</span><span class="op">}</span><span class="op">}</span>, 
      .fns <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span>
    <span class="op">)</span>
  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="co"># rescale gene expression</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span>
      .cols <span class="op">=</span> <span class="op">{</span><span class="op">{</span><span class="va">genes_of_interest</span><span class="op">}</span><span class="op">}</span>, 
      .fns <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="../reference/normalize.html">normalize</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="co"># ensure a range from 0 to 1</span>
    <span class="op">)</span>, 
    bins_numeric <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">bins_circle</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="co"># convert to numeric variable</span>
  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">bins_numeric</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html" class="external-link">everything</a></span><span class="op">(</span><span class="op">)</span>, <span class="op">-</span><span class="va">bins_circle</span><span class="op">)</span>

<span class="co"># show results </span>
<span class="va">smrd_df</span></code></pre></div>
<pre><code><span class="co">## <span style="color: #949494;"># A tibble: 34 x 4</span></span>
<span class="co">##    bins_numeric   FN1  MYL6 MCTS1</span>
<span class="co">##           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;"> 1</span>            0 0.610 0     0.304</span>
<span class="co">## <span style="color: #BCBCBC;"> 2</span>            1 0.961 0.151 0.283</span>
<span class="co">## <span style="color: #BCBCBC;"> 3</span>            2 1     0.241 0.342</span>
<span class="co">## <span style="color: #BCBCBC;"> 4</span>            3 0.970 0.222 0.763</span>
<span class="co">## <span style="color: #BCBCBC;"> 5</span>            4 0.944 0.308 0.507</span>
<span class="co">## <span style="color: #BCBCBC;"> 6</span>            5 0.982 0.280 0.563</span>
<span class="co">## <span style="color: #BCBCBC;"> 7</span>            6 0.920 0.324 0.523</span>
<span class="co">## <span style="color: #BCBCBC;"> 8</span>            7 0.871 0.327 0.840</span>
<span class="co">## <span style="color: #BCBCBC;"> 9</span>            8 0.855 0.371 0.745</span>
<span class="co">## <span style="color: #BCBCBC;">10</span>            9 0.843 0.396 0.643</span>
<span class="co">## <span style="color: #949494;"># i 24 more rows</span></span></code></pre>
<p>Using scatter- or lineplots, the expression change of a gene can be
plotted against the distance to the necrotic area.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># create plot</span>
<span class="va">shifted_df</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>
    data <span class="op">=</span> <span class="va">smrd_df</span>, 
    cols <span class="op">=</span> <span class="op">{</span><span class="op">{</span><span class="va">genes_of_interest</span><span class="op">}</span><span class="op">}</span>, 
    names_to <span class="op">=</span> <span class="st">"genes"</span>, 
    values_to <span class="op">=</span> <span class="st">"values"</span>
  <span class="op">)</span> 

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">shifted_df</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">bins_numeric</span>, y <span class="op">=</span> <span class="va">values</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0.5</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span> <span class="co"># indicate image annotation border</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span>facets <span class="op">=</span> <span class="va">.</span> <span class="op">~</span> <span class="va">genes</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>
    axis.line.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_line</a></span><span class="op">(</span>
      arrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html" class="external-link">arrow</a></span><span class="op">(</span>length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0.075</span>, <span class="st">"inches"</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"closed"</span><span class="op">)</span>
      <span class="op">)</span>,
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Circular Bins"</span><span class="op">)</span></code></pre></div>
<p><img src="cc-image-annotation-screening_files/figure-html/unnamed-chunk-13-1.png" width="100%"></p>
<p>While genes <em>FN1</em> and <em>MYL6</em> follow a clear descending
or ascending trend gene <em>MCTS1</em> does not. The corresponding
surface plots visualize that, too. <em>FN1</em> is expressed highly in
close proximity to the necrotic_center. The expression levels decrease
with the distance to the area (model: linear descending). The opposite
is true for gene <em>MYL6</em> which increases with the distance to the
necrotic area (model: linear ascending). Note, that the dashed line
indicates the positioning of the image annotation border. The bin left
to it corresponds to the mean expression <strong>inside</strong> the
image annotation. Depending on the argument <code>include_area</code>
this can be integrated in the visualization or not.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plotSurfaceComparison.html">plotSurfaceComparison</a></span><span class="op">(</span>
  object <span class="op">=</span> <span class="va">object_t313</span>,
  color_by <span class="op">=</span> <span class="va">genes_of_interest</span>, 
  display_image <span class="op">=</span> <span class="cn">FALSE</span>, 
  pt_clrsp <span class="op">=</span> <span class="st">"Greens 3"</span>,
  nrow <span class="op">=</span> <span class="fl">1</span>
<span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="../reference/ggpLayerEncirclingIAS.html">ggpLayerEncirclingIAS</a></span><span class="op">(</span>
    object <span class="op">=</span> <span class="va">object_t313</span>, 
    id <span class="op">=</span> <span class="st">"necrotic_center"</span>, 
    distance <span class="op">=</span> <span class="st">"2.25mm"</span>, 
    binwidth <span class="op">=</span> <span class="st">"225um"</span>, 
    line_size <span class="op">=</span> <span class="fl">0.75</span>,
    line_size_core <span class="op">=</span> <span class="fl">1</span>
  <span class="op">)</span> </code></pre></div>
<p><img src="cc-image-annotation-screening_files/figure-html/unnamed-chunk-14-1.png" width="100%"></p>
</div>
<div class="section level3">
<h3 id="screening-gene-expression-changes">3.3. Screening gene expression changes<a class="anchor" aria-label="anchor" href="#screening-gene-expression-changes"></a>
</h3>
<p>Click <a href="cc-model-fitting-spatial-transcriptomic-studies.html">here</a> to
be guided to the vignette that explains how the inferred expression
changes are fitted to models to find genes such as <em>FN1</em> and
<em>MYL6</em>.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Jan Kueckelhaus, Dieter-Henrik Heiland, Simon Frerich.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
