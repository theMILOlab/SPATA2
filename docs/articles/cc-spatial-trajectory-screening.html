<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spatial Trajectory Screening - Code &amp; Concept • SPATA2</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Spatial Trajectory Screening - Code &amp; Concept">
<meta property="og:description" content="SPATA2">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SPATA2</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/spata-v2-installation.html">Installation</a>
</li>
<li>
  <a href="../articles/spata-v2-spata-data.html">SPATAData</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Around the Spata-Object</li>
    <li>
      <a href="../articles/spata-v2-object-initiation-and-manipulation.html">Object Set Up and Manipulation</a>
    </li>
    <li>
      <a href="../articles/">Genes, Gene Sets and Features</a>
    </li>
    <li class="dropdown-header">Integrating Different Platforms</li>
    <li>
      <a href="../articles/spata-v2-cnv-analysis.html">Copy Number Variations</a>
    </li>
    <li>
      <a href="../articles/spata-v2-segmentation.html">Spatial Segmentation (Manual Annotation)</a>
    </li>
    <li>
      <a href="../articles/spata-v2-dea.html">Differential Expression Analysis</a>
    </li>
    <li>
      <a href="../articles/spata-v2-gsea.html">Gene Set Enrichment Analysis</a>
    </li>
    <li class="dropdown-header">Gradient Screening</li>
    <li>
      <a href="../articles/spata-v2-trajectory-analysis.html">Spatial Trajectories</a>
    </li>
    <li>
      <a href="../articles/spata-v2-spatial-trajectory-screening.html">Spatial Trajectory Screening</a>
    </li>
    <li>
      <a href="../articles/spata-v2-image-annotations.html">Image Annotations</a>
    </li>
    <li>
      <a href="../articles/spata-v2-image-annotation-screening.html">Image Annotation Screening</a>
    </li>
    <li class="dropdown-header">Visualization</li>
    <li>
      <a href="../articles/spata-v2-plotting-surface.html">Surface Plotting</a>
    </li>
    <li>
      <a href="../articles/spata-v2-plotting-misc.html">Miscellaneous</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Code &amp; Concept
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/cc-spatial-measures.html">Spatial Measures</a>
    </li>
    <li>
      <a href="../articles/cc-spatial-segmentation-vs-image-annotation.html">Spatial Segmentation vs. Image Annotations</a>
    </li>
    <li>
      <a href="../articles/cc-spatial-trajectory-screening.html">Spatial Trajectory Screening</a>
    </li>
    <li>
      <a href="../articles/cc-image-annotation-screening.html">Image Annotation Screening</a>
    </li>
    <li>
      <a href="../articles/cc-model-fitting-in-spatial-transcriptomic-studies.html">Model Fitting</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Spatial Trajectory Screening - Code &amp;
Concept</h1>
                        <h4 data-toc-skip class="author">Jan
Kueckelhaus</h4>
            
            <h4 data-toc-skip class="date">2022-08-20</h4>
      
      
      <div class="hidden name"><code>cc-spatial-trajectory-screening.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="prerequisites">1. Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites"></a>
</h2>
<p>None.</p>
</div>
<div class="section level2">
<h2 id="introduction-overview">2. Introduction &amp; overview<a class="anchor" aria-label="anchor" href="#introduction-overview"></a>
</h2>
<p>With spatial trajectory analysis <strong>SPATA2</strong> introduces a
new approach to find, analyze and visualize differently expressed genes
in a spatial context. While the classic differential gene expression
analyzes differences between groups as a whole it neglects changes of
expression levels that can only be observed while maintaining the
spatial dimensions. Spatial trajectories allow to answer questions that
include such a spatial component. In how far do expression levels change
the more one moves towards a region of interest or away from it? Which
genes follow the same pattern along these paths?</p>
<p>The spatial trajectory screening algorithm can be divided in three
parts.</p>
<ul>
<li>1.) Setting up a spatial trajectory (drawing and vector
projection)</li>
<li>2.) Inferring gene expression changes along the trajectory.</li>
<li>3.) Screening gene expression changes for biologically interesting
behaviors by fitting expression changes against predefined models.</li>
</ul>
<p>This vignette explains all steps of part 1.) and 2.) of the
algorithm. Part 3.) is explained in the tutorial on <a href="">Model
Fitting in Spatial Transcriptomic Studies</a>.</p>
<p>As an example we are using a spatial transcriptomic sample of a
central nervous system malignancy that features three different,
adjacent histological areas: Tumor, a transition zone as well as
infiltrated cortex.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://themilolab.com/" class="external-link">SPATA2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">SPATAData</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span>

<span class="va">object_t269</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SPATAData/man/downloadSpataObject.html" class="external-link">downloadSpataObject</a></span><span class="op">(</span>sample_name <span class="op">=</span> <span class="st">"269_T"</span><span class="op">)</span>

<span class="co"># load example image annotations</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"image_annotations"</span><span class="op">)</span>

<span class="va">object_t269</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="../reference/setImageAnnotation.html">setImageAnnotations</a></span><span class="op">(</span>
    object <span class="op">=</span> <span class="va">object_t269</span>, 
    img_anns <span class="op">=</span> <span class="va">image_annotations</span><span class="op">[[</span><span class="st">"269_T"</span><span class="op">]</span><span class="op">]</span>,
    overwrite <span class="op">=</span> <span class="cn">TRUE</span>
  <span class="op">)</span>

<span class="co"># plot results</span>
<span class="fu"><a href="../reference/plotImageGgplot.html">plotImageGgplot</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">object_t269</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="../reference/ggpLayerFrameByCoords.html">ggpLayerFrameByCoords</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">object_t269</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="../reference/ggpLayerThemeCoords.html">ggpLayerThemeCoords</a></span><span class="op">(</span><span class="op">)</span>

<span class="fu"><a href="../reference/plotImageAnnotations.html">plotImageAnnotations</a></span><span class="op">(</span>
  object <span class="op">=</span> <span class="va">object_t269</span>,
  tags <span class="op">=</span> <span class="st">"hist_example"</span>, 
  square <span class="op">=</span> <span class="cn">TRUE</span>,
  expand <span class="op">=</span> <span class="fl">0.5</span>, 
  encircle <span class="op">=</span> <span class="cn">FALSE</span>, 
  nrow <span class="op">=</span> <span class="fl">2</span>, 
  display_caption <span class="op">=</span> <span class="cn">FALSE</span>
<span class="op">)</span></code></pre></div>
<p><img src="cc-spatial-trajectory-screening_files/figure-html/unnamed-chunk-3-1.png" width="50%"><img src="cc-spatial-trajectory-screening_files/figure-html/unnamed-chunk-3-2.png" width="50%"></p>
</div>
<div class="section level2">
<h2 id="setting-up-a-spatial-trajectory">3. Setting up a spatial trajectory<a class="anchor" aria-label="anchor" href="#setting-up-a-spatial-trajectory"></a>
</h2>
<p>The example spatial trajectory that we are using throughout this
vignette was drawn via the function <code><a href="../reference/createSpatialTrajectories.html">addSpatialTrajectory()</a></code>
and is displayed in figure 1.1. It shows a surface plot that is colored
by the expression of gene <em>MPL</em>. Next to it the example
trajectory is visualized which runs across the whole sample indicating a
<em>from tumor to cortex</em>-direction.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># creates trajectory manually </span>
<span class="co"># alternatively you can draw it interactively with `createSpatialTrajectories()`</span>
<span class="va">object_t269</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="../reference/createSpatialTrajectories.html">addSpatialTrajectory</a></span><span class="op">(</span>
    object <span class="op">=</span> <span class="va">object_t269</span>, 
    id <span class="op">=</span> <span class="st">"horizontal_mid"</span>,
    width <span class="op">=</span> <span class="st">"1.5mm"</span>,
    start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"1.35mm"</span>, y <span class="op">=</span> <span class="st">"4mm"</span><span class="op">)</span>,
    end <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"6.35mm"</span>, y <span class="op">=</span> <span class="st">"4mm"</span><span class="op">)</span>, 
    overwrite <span class="op">=</span> <span class="cn">TRUE</span>
  <span class="op">)</span>

<span class="fu"><a href="../reference/plotSurface.html">plotSurface</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">object_t269</span>, color_by <span class="op">=</span> <span class="st">"MAG"</span><span class="op">)</span> 

<span class="fu"><a href="../reference/plotSpatialTrajectories.html">plotSpatialTrajectories</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">object_t269</span>, ids <span class="op">=</span> <span class="st">"horizontal_mid"</span>, color_by <span class="op">=</span> <span class="st">"MAG"</span><span class="op">)</span></code></pre></div>
<p><img src="cc-spatial-trajectory-screening_files/figure-html/unnamed-chunk-4-1.png" width="50%"><img src="cc-spatial-trajectory-screening_files/figure-html/unnamed-chunk-4-2.png" width="50%"></p>
<p>Both functions, <code><a href="../reference/createSpatialTrajectories.html">createSpatialTrajectories()</a></code> and
<code><a href="../reference/createSpatialTrajectories.html">addSpatialTrajectory()</a></code> result in the same. They <em>set
up</em> spatial trajectories by doing the necessary computations and by
storing the results in the <code>spata2</code> object.
<code><a href="../reference/createSpatialTrajectories.html">createSpatialTrajectories()</a></code> gives access to an interactive
interface where start- and endpoint are set by clicking on the plot.
With <code><a href="../reference/createSpatialTrajectories.html">addSpatialTrajectory()</a></code> start- and endpoint are set
<em>programmatically</em>.</p>
<p>The process of setting up a trajectory can be splitted into three
steps:</p>
<ul>
<li>Step 1: Drawing the trajectory by setting the trajectory’s start and
endpoint.</li>
<li>Step 2: Filtering the barcode-spots that fall into the trajectory’s
reach.</li>
<li>Step 3: Integrating the trajectory’s direction by setting every
barcode-spot in relation to the trajectory’s origin and computing the
projection length.</li>
</ul>
<p>The chapters below elaborate on each of these three steps and shows
the underlying code that is needed to reproduce what is happening in the
functions <code><a href="../reference/createSpatialTrajectories.html">createSpatialTrajectories()</a></code> or
<code><a href="../reference/createSpatialTrajectories.html">addSpatialTrajectory()</a></code>.</p>
<div class="section level3">
<h3 id="drawing-the-trajectory">3.1 Drawing the trajectory<a class="anchor" aria-label="anchor" href="#drawing-the-trajectory"></a>
</h3>
<p>In order to draw the trajectory a surface plot is required.
Extracting the coordinates of all barcode-spots via
<code>getCoordinates()</code> provides the basic data.frame needed.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># get coordinate of barcode-spots</span>
<span class="va">coords_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getCoordsDf.html">getCoordsDf</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">object_t269</span><span class="op">)</span>

<span class="co"># show results </span>
<span class="va">coords_df</span></code></pre></div>
<pre><code><span class="co">## <span style="color: #949494;"># A tibble: 3,213 x 4</span></span>
<span class="co">##    barcodes           sample     x     y</span>
<span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;"> 1</span> AAACAAGTATCTCCCA-1 269_T  <span style="text-decoration: underline;">1</span>450.  731.</span>
<span class="co">## <span style="color: #BCBCBC;"> 2</span> AAACACCAATAACTGC-1 269_T   411.  547.</span>
<span class="co">## <span style="color: #BCBCBC;"> 3</span> AAACAGAGCGACTCCT-1 269_T  <span style="text-decoration: underline;">1</span>359. <span style="text-decoration: underline;">1</span>516 </span>
<span class="co">## <span style="color: #BCBCBC;"> 4</span> AAACATTTCCCGGATT-1 269_T  <span style="text-decoration: underline;">1</span>386.  493.</span>
<span class="co">## <span style="color: #BCBCBC;"> 5</span> AAACCCGAACGAAATC-1 269_T  <span style="text-decoration: underline;">1</span>614.  838.</span>
<span class="co">## <span style="color: #BCBCBC;"> 6</span> AAACCGGGTAGGTACC-1 269_T   527.  916.</span>
<span class="co">## <span style="color: #BCBCBC;"> 7</span> AAACCGTTCGTCCAGG-1 269_T   700.  696 </span>
<span class="co">## <span style="color: #BCBCBC;"> 8</span> AAACCTAAGCAGCCGG-1 269_T  <span style="text-decoration: underline;">1</span>210.  408.</span>
<span class="co">## <span style="color: #BCBCBC;"> 9</span> AAACCTCATGAAGTTG-1 269_T   416. <span style="text-decoration: underline;">1</span>026.</span>
<span class="co">## <span style="color: #BCBCBC;">10</span> AAACGAGACGGTTGAT-1 269_T  <span style="text-decoration: underline;">1</span>167. <span style="text-decoration: underline;">1</span>061.</span>
<span class="co">## <span style="color: #949494;"># i 3,203 more rows</span></span></code></pre>
<p>The start- and endpoint of the trajectory are determined and stored
in a data.frame like the one shown below.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/as_unit.html">as_pixel</a></span><span class="op">(</span>input <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"1.35mm"</span>, <span class="st">"4mm"</span>, <span class="st">"6.35mm"</span><span class="op">)</span>, object <span class="op">=</span> <span class="va">object_t269</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1]  338.9095 1004.1762 1594.1297</span>
<span class="co">## attr(,"unit")</span>
<span class="co">## [1] "px"</span></code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># using pixel units here</span>
<span class="va">segm_df</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>
    x <span class="op">=</span> <span class="fl">340</span>,
    y <span class="op">=</span> <span class="fl">1000</span>,
    xend <span class="op">=</span> <span class="fl">1600</span>, 
    yend <span class="op">=</span> <span class="fl">1000</span>, 
    part <span class="op">=</span> <span class="st">"part_1"</span>
  <span class="op">)</span>

<span class="co"># show results </span>
<span class="va">segm_df</span></code></pre></div>
<pre><code><span class="co">## <span style="color: #949494;"># A tibble: 1 x 5</span></span>
<span class="co">##       x     y  xend  yend part  </span>
<span class="co">##   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> </span>
<span class="co">## <span style="color: #BCBCBC;">1</span>   340  <span style="text-decoration: underline;">1</span>000  <span style="text-decoration: underline;">1</span>600  <span style="text-decoration: underline;">1</span>000 part_1</span></code></pre>
<p>Mapping the x- and y-coordinates of the barcode-spots to the
respective x- and y-aesthetics results in a basic surface plot. The
data.frame above contains information about start- and endpoint of the
trajectory which can be used to plot the trajectory’s course.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">no_panel_grid</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>
    panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>, 
    panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>
  <span class="op">)</span>

<span class="co"># display x- and y-coordinates of all barcode-spots</span>
<span class="va">surface_plot</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">coords_df</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"lightgrey"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="co"># provide point geometry</span>
  <span class="fu"><a href="../reference/scale_color_add_on.html">scale_color_add_on</a></span><span class="op">(</span>aes <span class="op">=</span> <span class="st">"fill"</span>, variable <span class="op">=</span> <span class="st">"discrete"</span>, clrp <span class="op">=</span> <span class="st">"milo"</span><span class="op">)</span> <span class="op">+</span> <span class="co"># SPATA-intern wrapper </span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_equal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="va">no_panel_grid</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>

<span class="co"># save the trajectory layer </span>
<span class="va">trajectory</span> <span class="op">&lt;-</span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html" class="external-link">geom_segment</a></span><span class="op">(</span>
      data <span class="op">=</span> <span class="va">segm_df</span>, 
      mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, xend <span class="op">=</span> <span class="va">xend</span>, yend <span class="op">=</span> <span class="va">yend</span><span class="op">)</span>, 
      size <span class="op">=</span> <span class="fl">1.75</span>, 
      arrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html" class="external-link">arrow</a></span><span class="op">(</span>length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0.125</span>, <span class="st">"inches"</span><span class="op">)</span><span class="op">)</span>
      <span class="op">)</span> 

<span class="co"># plot results</span>
<span class="va">surface_plot</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>subtitle <span class="op">=</span> <span class="st">"a) Surface"</span><span class="op">)</span>

<span class="va">surface_plot</span> <span class="op">+</span>
  <span class="va">trajectory</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>subtitle <span class="op">=</span> <span class="st">"b) Surface + trajectory"</span><span class="op">)</span></code></pre></div>
<p><img src="cc-spatial-trajectory-screening_files/figure-html/unnamed-chunk-7-1.png" width="50%"><img src="cc-spatial-trajectory-screening_files/figure-html/unnamed-chunk-7-2.png" width="50%"></p>
</div>
<div class="section level3">
<h3 id="filtering-barcode-spots">3.2 Filtering barcode-spots<a class="anchor" aria-label="anchor" href="#filtering-barcode-spots"></a>
</h3>
<p>A trajectory includes only a subset of barcode-spots. To determine
the barcode-spots that fall into the trajectory’s reach the trajectory’s
<strong>width</strong> needs to be determined.</p>
<p>With that value two additional vectors can be computed that each
cross the trajectory’s start- and endpoint orthogonally. Start- and
endpoint of these crossing vectors determine the vertices of the
rectangle that includes all the barcode-spots that fall into the
trajectory’s reach. The higher the value for the trajectory’s width the
wider it gets and the more barcode-spots it includes.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># determines the width of the trajectory (in pixel)</span>
<span class="va">trajectory_width</span> <span class="op">&lt;-</span> <span class="fl">350</span>

<span class="va">start_point</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">segm_df</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>
<span class="va">end_point</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">segm_df</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span>

<span class="va">trajectory_vec</span> <span class="op">&lt;-</span> <span class="va">end_point</span> <span class="op">-</span> <span class="va">start_point</span>

<span class="co"># show results</span>
<span class="va">trajectory_vec</span></code></pre></div>
<pre><code><span class="co">## [1] 1260    0</span></code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># factor with which to compute the width vector</span>
<span class="va">trajectory_magnitude</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">trajectory_vec</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="op">(</span><span class="va">trajectory_vec</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>
<span class="va">trajectory_factor</span> <span class="op">&lt;-</span> <span class="va">trajectory_width</span> <span class="op">/</span> <span class="va">trajectory_magnitude</span>

<span class="co"># orthogonal trajectory vector</span>
<span class="va">orth_trajectory_vec</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="va">trajectory_vec</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">trajectory_vec</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="va">trajectory_factor</span><span class="op">)</span>

<span class="co"># show results</span>
<span class="va">orth_trajectory_vec</span></code></pre></div>
<pre><code><span class="co">## [1]   0 350</span></code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># determine trajectory frame points 'tfps' making up the square that embraces</span>
<span class="co"># the points</span>
<span class="va">tfp1.1</span> <span class="op">&lt;-</span> <span class="va">start_point</span> <span class="op">+</span> <span class="va">orth_trajectory_vec</span>
<span class="va">tfp1.2</span> <span class="op">&lt;-</span> <span class="va">start_point</span> <span class="op">-</span> <span class="va">orth_trajectory_vec</span>
<span class="va">tfp2.1</span> <span class="op">&lt;-</span> <span class="va">end_point</span> <span class="op">-</span> <span class="va">orth_trajectory_vec</span>
<span class="va">tfp2.2</span> <span class="op">&lt;-</span> <span class="va">end_point</span> <span class="op">+</span> <span class="va">orth_trajectory_vec</span>

<span class="va">rectangular_df</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>
    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">tfp1.1</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">tfp1.2</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">tfp2.1</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">tfp2.2</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, 
    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">tfp1.1</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">tfp1.2</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">tfp2.1</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">tfp2.2</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, 
    label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"D"</span>, <span class="st">"C"</span>, <span class="st">"B"</span><span class="op">)</span>
  <span class="op">)</span>

<span class="co"># show results </span>
<span class="va">rectangular_df</span></code></pre></div>
<pre><code><span class="co">## <span style="color: #949494;"># A tibble: 4 x 3</span></span>
<span class="co">##       x     y label</span>
<span class="co">##   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;">1</span>   340  <span style="text-decoration: underline;">1</span>350 A    </span>
<span class="co">## <span style="color: #BCBCBC;">2</span>   340   650 D    </span>
<span class="co">## <span style="color: #BCBCBC;">3</span>  <span style="text-decoration: underline;">1</span>600   650 C    </span>
<span class="co">## <span style="color: #BCBCBC;">4</span>  <span style="text-decoration: underline;">1</span>600  <span style="text-decoration: underline;">1</span>350 B</span></code></pre>
<p>The function <code>point.in.polygon()</code>of the
<strong>sp</strong>-package allows to filter the data.frame that
contains information about all barcode-spots for those spots that fall
into the polygon and thus in the trajectory’s reach.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># get a logical vector indicating if a barcode spot falls into the trajectory's reach or not </span>
<span class="va">positions</span> <span class="op">&lt;-</span> 
  <span class="fu">sp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/point.in.polygon.html" class="external-link">point.in.polygon</a></span><span class="op">(</span>
    point.x <span class="op">=</span> <span class="va">coords_df</span><span class="op">$</span><span class="va">x</span>,
    point.y <span class="op">=</span> <span class="va">coords_df</span><span class="op">$</span><span class="va">y</span>,
    pol.x <span class="op">=</span> <span class="va">rectangular_df</span><span class="op">$</span><span class="va">x</span>,
    pol.y <span class="op">=</span> <span class="va">rectangular_df</span><span class="op">$</span><span class="va">y</span>
    <span class="op">)</span>

<span class="co"># show results</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">positions</span>, <span class="fl">10</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">##  [1] 1 0 0 0 0 1 1 0 1 1</span></code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># keep only those that fall into the trajectory's reach (not 0)</span>
<span class="va">barcode_spots_of_interest</span> <span class="op">&lt;-</span> <span class="va">coords_df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">as.logical</a></span><span class="op">(</span><span class="va">positions</span><span class="op">)</span>, <span class="op">]</span>
      
<span class="co"># visualize filtered spots</span>
<span class="va">trajectory_spots</span> <span class="op">&lt;-</span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>
      data <span class="op">=</span> <span class="va">barcode_spots_of_interest</span>,
      mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span>,
      alpha <span class="op">=</span> <span class="fl">0.5</span>,
      size <span class="op">=</span> <span class="fl">2</span>, 
      color <span class="op">=</span> <span class="st">"steelblue"</span>
      <span class="op">)</span>

<span class="co"># visualize the vertices of the polygon</span>
<span class="co"># based on which the barcode-spots were filtered</span>
<span class="va">vertices</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span>
    data <span class="op">=</span> <span class="va">rectangular_df</span>,
    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, label <span class="op">=</span> <span class="va">label</span><span class="op">)</span>, 
    size <span class="op">=</span> <span class="fl">7.5</span>
  <span class="op">)</span>

<span class="co"># plot results</span>
<span class="va">surface_plot</span> <span class="op">+</span> <span class="va">trajectory_spots</span> <span class="op">+</span> <span class="va">trajectory</span> <span class="op">+</span> <span class="va">vertices</span></code></pre></div>
<p><img src="cc-spatial-trajectory-screening_files/figure-html/unnamed-chunk-9-1.png" width="50%"></p>
</div>
<div class="section level3">
<h3 id="integrating-a-spatial-direction">3.3 Integrating a spatial direction<a class="anchor" aria-label="anchor" href="#integrating-a-spatial-direction"></a>
</h3>
<p>In order to integrate the direction of the trajectory as an
informative variable every barcode-spot needs to be set into relation to
the trajectory’s course. The closer a barcode-spot is located towards
the trajectory’s origin the smaller the respective value needs to
be.</p>
<p>This is achieved by projecting the barcode-spots position onto the
vector that corresponds to the trajectory’s course. The local coordinate
system of the figure below is build around all relevant barcode-spots
whereby it’s x- and y-axis correspond to the trajectory’s width (local
width axis, lwa) and the trajectory itself (local length axis, lla),
albeit displaced towards the edge.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># set up a local coordinate system </span>
<span class="va">lcs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>
  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">tfp1.1</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">tfp1.1</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>,
  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">tfp1.1</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">tfp1.1</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>,
  xend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">tfp2.2</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">tfp1.2</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>,
  yend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">tfp2.2</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">tfp1.2</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>,
  use <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"local length axis"</span>, <span class="st">"local width axis"</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># show results</span>
<span class="va">lcs</span></code></pre></div>
<pre><code><span class="co">##     x    y xend yend               use</span>
<span class="co">## 1 340 1350 1600 1350 local length axis</span>
<span class="co">## 2 340 1350  340  650  local width axis</span></code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># local coordinate system layer</span>
<span class="va">local_coordinate_system</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html" class="external-link">geom_segment</a></span><span class="op">(</span>
      data <span class="op">=</span> <span class="va">lcs</span>, 
      mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, xend <span class="op">=</span> <span class="va">xend</span>, yend <span class="op">=</span> <span class="va">yend</span><span class="op">)</span>,
      arrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html" class="external-link">arrow</a></span><span class="op">(</span>length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0.125</span>, <span class="st">"inches"</span><span class="op">)</span><span class="op">)</span>,
      size <span class="op">=</span> <span class="fl">1.5</span>
      <span class="op">)</span>
  <span class="op">)</span>

<span class="co"># plot results</span>
<span class="va">surface_plot</span> <span class="op">+</span> 
  <span class="va">trajectory_spots</span> <span class="op">+</span> 
  <span class="va">local_coordinate_system</span></code></pre></div>
<p><img src="cc-spatial-trajectory-screening_files/figure-html/unnamed-chunk-10-1.png" width="50%"></p>
<p>The local length axis inherits it’s direction and course from the
original trajectory. In order to arrange the barcode-spots according to
the trajectory’s direction their projection onto the local length axis
needs to be calculated via vector-projection which requires two main
steps.</p>
<p>1.) Calculate vector <em>a</em> that connects the barcode-spot of
interest to the origin of the local coordinate system. Then project
vector <em>a</em> onto the local length axis (lla) such that <span class="math inline">\(\vec{proj} = \frac{\vec{sto} *
\vec{traj}}{||\vec{traj}||^2} * \vec{traj}\)</span></p>
<p>2.) Calculate the magnitude of the vector that corresponds to the
projection: <span class="math inline">\(proj.length =
|\vec{proj}|\)</span></p>
<p>The higher the calculated projection length the higher the distance
between the barcode-spot and the origin of the trajectory.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">vector_projection</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">lcs</span>, <span class="va">x_coordinate</span>, <span class="va">y_coordinate</span><span class="op">)</span><span class="op">{</span>

  <span class="co"># vector from point of interest to origin of local coord system: vector to origin 'vto'</span>
  <span class="va">vto</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">(</span><span class="va">x_coordinate</span> <span class="op">-</span> <span class="va">lcs</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="op">(</span><span class="va">y_coordinate</span> <span class="op">-</span> <span class="va">lcs</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>

  <span class="co"># define local length axis (= relocated trajectory): 'lla'</span>
  <span class="va">lla</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">(</span><span class="va">lcs</span><span class="op">$</span><span class="va">xend</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">lcs</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="op">(</span><span class="va">lcs</span><span class="op">$</span><span class="va">yend</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">lcs</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>

  <span class="co"># define lambda coefficient</span>
  <span class="va">lambda</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="op">(</span><span class="va">vto</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="va">lla</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">vto</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">*</span> <span class="va">lla</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">lla</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="op">(</span><span class="va">lla</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span>

  <span class="co"># projecting vector on local length axis</span>
  <span class="va">pv</span> <span class="op">&lt;-</span> <span class="va">lambda</span> <span class="op">*</span> <span class="op">(</span><span class="va">lla</span><span class="op">)</span>

  <span class="co"># compute the length of the projected vector -&gt; projection length!</span>
  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">pv</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="op">(</span><span class="va">pv</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>

  <span class="co"># return the result</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span>

<span class="op">}</span>

<span class="co"># points of interest data.frame</span>
<span class="va">barcode_spots_arranged</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span>.data <span class="op">=</span> <span class="va">barcode_spots_of_interest</span>, <span class="va">barcodes</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>projection_length <span class="op">=</span> <span class="fu">vector_projection</span><span class="op">(</span>lcs <span class="op">=</span> <span class="va">lcs</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">projection_length</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>  <span class="co"># arrange barcodes according to their projection value</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># show results</span>
<span class="va">barcode_spots_arranged</span></code></pre></div>
<pre><code><span class="co">## <span style="color: #949494;"># A tibble: 1,623 x 5</span></span>
<span class="co">##    barcodes           sample     x     y projection_length</span>
<span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;"> 1</span> GATCGGATAGAACCAT-1 269_T   340.  939.             0.225</span>
<span class="co">## <span style="color: #BCBCBC;"> 2</span> ACGCTGTGAGGCGTAG-1 269_T   341.  983.             0.624</span>
<span class="co">## <span style="color: #BCBCBC;"> 3</span> GTCTACTCAATTACAA-1 269_T   341. <span style="text-decoration: underline;">1</span>026.             1.02 </span>
<span class="co">## <span style="color: #BCBCBC;"> 4</span> CACTCGGTTAGGAGGA-1 269_T   341. <span style="text-decoration: underline;">1</span>070              1.42 </span>
<span class="co">## <span style="color: #BCBCBC;"> 5</span> GGTTGTGTAGCCTGGC-1 269_T   342. <span style="text-decoration: underline;">1</span>113.             2.22 </span>
<span class="co">## <span style="color: #BCBCBC;"> 6</span> GCGTTATATTTGGAAC-1 269_T   343. <span style="text-decoration: underline;">1</span>157.             2.62 </span>
<span class="co">## <span style="color: #BCBCBC;"> 7</span> GTCAGTTTGGTAGTCG-1 269_T   343. <span style="text-decoration: underline;">1</span>200.             3.02 </span>
<span class="co">## <span style="color: #BCBCBC;"> 8</span> GCTAAGTAAAGGCGAT-1 269_T   343. <span style="text-decoration: underline;">1</span>244              3.42 </span>
<span class="co">## <span style="color: #BCBCBC;"> 9</span> GCTCGCGGTTCCGCTC-1 269_T   344. <span style="text-decoration: underline;">1</span>288.             3.82 </span>
<span class="co">## <span style="color: #BCBCBC;">10</span> GCAGATCCTCGCAAAT-1 269_T   344. <span style="text-decoration: underline;">1</span>331.             4.22 </span>
<span class="co">## <span style="color: #949494;"># i 1,613 more rows</span></span></code></pre>
<p>The projection length of every barcode spot in relation to the
spatial trajectory can be visualized by coloring the spots
accordingly.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># projection length layer</span>
<span class="va">projected_length</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>
      data <span class="op">=</span> <span class="va">barcode_spots_arranged</span>,
      size <span class="op">=</span> <span class="fl">2</span>,
      mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, color <span class="op">=</span> <span class="va">projection_length</span><span class="op">)</span>
      <span class="op">)</span>, 
    <span class="fu"><a href="../reference/scale_color_add_on.html">scale_color_add_on</a></span><span class="op">(</span>clrsp <span class="op">=</span> <span class="st">"plasma"</span><span class="op">)</span>, 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"Projection-\nLength (PL)"</span><span class="op">)</span>
  <span class="op">)</span>

<span class="co"># plot results </span>
<span class="va">surface_plot</span> <span class="op">+</span> <span class="va">projected_length</span> <span class="op">+</span> <span class="va">local_coordinate_system</span></code></pre></div>
<p><img src="cc-spatial-trajectory-screening_files/figure-html/unnamed-chunk-12-1.png" width="50%"></p>
<p>This is what happens when a spatial trajectory is added via
<code><a href="../reference/createSpatialTrajectories.html">addSpatialTrajectory()</a></code> or created interactively by
<code><a href="../reference/createSpatialTrajectories.html">createSpatialTrajectories()</a></code> (which in turn uses
<code>addSpatialtrajectory()</code>). The results, namely the projection
length information of the barcode-spots in combination with the course
of the trajectory are stored in an S4 object of class
<code>SpatialTrajectory</code> within the <code>spata2</code>
object.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">traj_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getSpatialTrajectory.html">getSpatialTrajectory</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">object_t269</span>, id <span class="op">=</span> <span class="st">"horizontal_mid"</span><span class="op">)</span>

<span class="va">traj_obj</span></code></pre></div>
<pre><code><span class="co">## An object of class "SpatialTrajectory"</span>
<span class="co">## Slot "coords":</span>
<span class="co">## <span style="color: #949494;"># A tibble: 3,213 x 4</span></span>
<span class="co">##    barcodes           sample     x     y</span>
<span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;"> 1</span> AAACAAGTATCTCCCA-1 269_T  <span style="text-decoration: underline;">1</span>450.  731.</span>
<span class="co">## <span style="color: #BCBCBC;"> 2</span> AAACACCAATAACTGC-1 269_T   411.  547.</span>
<span class="co">## <span style="color: #BCBCBC;"> 3</span> AAACAGAGCGACTCCT-1 269_T  <span style="text-decoration: underline;">1</span>359. <span style="text-decoration: underline;">1</span>516 </span>
<span class="co">## <span style="color: #BCBCBC;"> 4</span> AAACATTTCCCGGATT-1 269_T  <span style="text-decoration: underline;">1</span>386.  493.</span>
<span class="co">## <span style="color: #BCBCBC;"> 5</span> AAACCCGAACGAAATC-1 269_T  <span style="text-decoration: underline;">1</span>614.  838.</span>
<span class="co">## <span style="color: #BCBCBC;"> 6</span> AAACCGGGTAGGTACC-1 269_T   527.  916.</span>
<span class="co">## <span style="color: #BCBCBC;"> 7</span> AAACCGTTCGTCCAGG-1 269_T   700.  696 </span>
<span class="co">## <span style="color: #BCBCBC;"> 8</span> AAACCTAAGCAGCCGG-1 269_T  <span style="text-decoration: underline;">1</span>210.  408.</span>
<span class="co">## <span style="color: #BCBCBC;"> 9</span> AAACCTCATGAAGTTG-1 269_T   416. <span style="text-decoration: underline;">1</span>026.</span>
<span class="co">## <span style="color: #BCBCBC;">10</span> AAACGAGACGGTTGAT-1 269_T  <span style="text-decoration: underline;">1</span>167. <span style="text-decoration: underline;">1</span>061.</span>
<span class="co">## <span style="color: #949494;"># i 3,203 more rows</span></span>
<span class="co">## </span>
<span class="co">## Slot "info":</span>
<span class="co">## $current_dim</span>
<span class="co">## [1] 1939 2000    3</span>
<span class="co">## </span>
<span class="co">## $current_just</span>
<span class="co">## $current_just$angle</span>
<span class="co">## [1] 0</span>
<span class="co">## </span>
<span class="co">## $current_just$flipped</span>
<span class="co">## $current_just$flipped$horizontal</span>
<span class="co">## [1] FALSE</span>
<span class="co">## </span>
<span class="co">## $current_just$flipped$vertical</span>
<span class="co">## [1] FALSE</span>
<span class="co">## </span>
<span class="co">## </span>
<span class="co">## </span>
<span class="co">## </span>
<span class="co">## Slot "width_unit":</span>
<span class="co">## [1] "mm"</span>
<span class="co">## </span>
<span class="co">## Slot "comment":</span>
<span class="co">## [1] ""</span>
<span class="co">## </span>
<span class="co">## Slot "id":</span>
<span class="co">## [1] "horizontal_mid"</span>
<span class="co">## </span>
<span class="co">## Slot "projection":</span>
<span class="co">## <span style="color: #949494;"># A tibble: 1,733 x 6</span></span>
<span class="co">##    barcodes           sample     x     y projection_length trajectory_part</span>
<span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          </span>
<span class="co">## <span style="color: #BCBCBC;"> 1</span> TGCGAATATGGGATTT-1 269_T   339.  852.             0.116 Part 1         </span>
<span class="co">## <span style="color: #BCBCBC;"> 2</span> TTGTGAGGCATGACGC-1 269_T   340.  896.             0.915 Part 1         </span>
<span class="co">## <span style="color: #BCBCBC;"> 3</span> GATCGGATAGAACCAT-1 269_T   340.  939.             1.32  Part 1         </span>
<span class="co">## <span style="color: #BCBCBC;"> 4</span> ACGCTGTGAGGCGTAG-1 269_T   341.  983.             1.71  Part 1         </span>
<span class="co">## <span style="color: #BCBCBC;"> 5</span> GTCTACTCAATTACAA-1 269_T   341. <span style="text-decoration: underline;">1</span>026.             2.11  Part 1         </span>
<span class="co">## <span style="color: #BCBCBC;"> 6</span> CACTCGGTTAGGAGGA-1 269_T   341. <span style="text-decoration: underline;">1</span>070              2.51  Part 1         </span>
<span class="co">## <span style="color: #BCBCBC;"> 7</span> GGTTGTGTAGCCTGGC-1 269_T   342. <span style="text-decoration: underline;">1</span>113.             3.31  Part 1         </span>
<span class="co">## <span style="color: #BCBCBC;"> 8</span> GCGTTATATTTGGAAC-1 269_T   343. <span style="text-decoration: underline;">1</span>157.             3.71  Part 1         </span>
<span class="co">## <span style="color: #BCBCBC;"> 9</span> GTCAGTTTGGTAGTCG-1 269_T   343. <span style="text-decoration: underline;">1</span>200.             4.11  Part 1         </span>
<span class="co">## <span style="color: #BCBCBC;">10</span> GCTAAGTAAAGGCGAT-1 269_T   343. <span style="text-decoration: underline;">1</span>244              4.51  Part 1         </span>
<span class="co">## <span style="color: #949494;"># i 1,723 more rows</span></span>
<span class="co">## </span>
<span class="co">## Slot "sample":</span>
<span class="co">## [1] "269_T"</span>
<span class="co">## </span>
<span class="co">## Slot "segment":</span>
<span class="co">##          x        y    xend     yend   part</span>
<span class="co">## 1 338.9095 1004.176 1594.13 1004.176 part_1</span>
<span class="co">## </span>
<span class="co">## Slot "width":</span>
<span class="co">## [1] 376.5661</span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="inferring-expression-changes-of-genes-along-the-trajectory">4. Inferring expression changes of genes along the trajectory<a class="anchor" aria-label="anchor" href="#inferring-expression-changes-of-genes-along-the-trajectory"></a>
</h2>
<p>The barcode-spots are now arranged according to their projection onto
the trajectory. By assigning them to groups by their
<em>projection_length</em>-values they are sorted into bins for which
the average expression values are calculated and in return plotted
against the trajectory’s direction. The example sorts the barcode-spots
in 7 bins.</p>
<p>(A higher number of bins is recommended to increase the resolution.
In fact, we recommend to determine the number of bins by specifying the
binwidth. We stick to 7 during this example to keep the plots clear and
easy to understand.)</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># use n_bins to specify the number of bins explicitly for visualization purposes</span>
<span class="co"># scroll down to the end of the vignette on why binwidth might be better</span>
<span class="va">n_bins</span> <span class="op">&lt;-</span> <span class="fl">10</span>

<span class="va">barcode_spots_binned</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>
    .data <span class="op">=</span> <span class="va">barcode_spots_arranged</span>, 
    bins_order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span><span class="va">projection_length</span>, breaks <span class="op">=</span> <span class="va">n_bins</span><span class="op">)</span>
  <span class="op">)</span>

<span class="co"># show results</span>
<span class="va">barcode_spots_binned</span></code></pre></div>
<pre><code><span class="co">## <span style="color: #949494;"># A tibble: 1,623 x 6</span></span>
<span class="co">##    barcodes           sample     x     y projection_length bins_order </span>
<span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>      </span>
<span class="co">## <span style="color: #BCBCBC;"> 1</span> GATCGGATAGAACCAT-1 269_T   340.  939.             0.225 (-1.03,126]</span>
<span class="co">## <span style="color: #BCBCBC;"> 2</span> ACGCTGTGAGGCGTAG-1 269_T   341.  983.             0.624 (-1.03,126]</span>
<span class="co">## <span style="color: #BCBCBC;"> 3</span> GTCTACTCAATTACAA-1 269_T   341. <span style="text-decoration: underline;">1</span>026.             1.02  (-1.03,126]</span>
<span class="co">## <span style="color: #BCBCBC;"> 4</span> CACTCGGTTAGGAGGA-1 269_T   341. <span style="text-decoration: underline;">1</span>070              1.42  (-1.03,126]</span>
<span class="co">## <span style="color: #BCBCBC;"> 5</span> GGTTGTGTAGCCTGGC-1 269_T   342. <span style="text-decoration: underline;">1</span>113.             2.22  (-1.03,126]</span>
<span class="co">## <span style="color: #BCBCBC;"> 6</span> GCGTTATATTTGGAAC-1 269_T   343. <span style="text-decoration: underline;">1</span>157.             2.62  (-1.03,126]</span>
<span class="co">## <span style="color: #BCBCBC;"> 7</span> GTCAGTTTGGTAGTCG-1 269_T   343. <span style="text-decoration: underline;">1</span>200.             3.02  (-1.03,126]</span>
<span class="co">## <span style="color: #BCBCBC;"> 8</span> GCTAAGTAAAGGCGAT-1 269_T   343. <span style="text-decoration: underline;">1</span>244              3.42  (-1.03,126]</span>
<span class="co">## <span style="color: #BCBCBC;"> 9</span> GCTCGCGGTTCCGCTC-1 269_T   344. <span style="text-decoration: underline;">1</span>288.             3.82  (-1.03,126]</span>
<span class="co">## <span style="color: #BCBCBC;">10</span> GCAGATCCTCGCAAAT-1 269_T   344. <span style="text-decoration: underline;">1</span>331.             4.22  (-1.03,126]</span>
<span class="co">## <span style="color: #949494;"># i 1,613 more rows</span></span></code></pre>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">averaged_points</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span>.data <span class="op">=</span> <span class="va">barcode_spots_binned</span>, <span class="va">bins_order</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>
    trajectory_order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">bins_order</span><span class="op">)</span> <span class="co"># convert factor levels to numbers</span>
  <span class="op">)</span>

<span class="va">projection_length_binned</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>
      data <span class="op">=</span> <span class="va">barcode_spots_binned</span>,
      mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, color <span class="op">=</span> <span class="va">bins_order</span><span class="op">)</span>
      <span class="op">)</span>
    <span class="op">)</span>

<span class="va">order_averaged</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>
      data <span class="op">=</span> <span class="va">barcode_spots_binned</span>,
      mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, color <span class="op">=</span> <span class="va">bins_order</span><span class="op">)</span>,
      alpha <span class="op">=</span> <span class="fl">0.3</span>
      <span class="op">)</span>,
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span>
      data <span class="op">=</span> <span class="va">averaged_points</span>,
      mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, color <span class="op">=</span> <span class="va">bins_order</span>, label <span class="op">=</span> <span class="va">trajectory_order</span><span class="op">)</span>,
      size <span class="op">=</span> <span class="fl">10</span>
      <span class="op">)</span>
  <span class="op">)</span>

<span class="co"># plot results</span>
<span class="va">surface_plot</span> <span class="op">+</span>
  <span class="va">projection_length_binned</span> <span class="op">+</span>
  <span class="va">trajectory</span> <span class="op">+</span>
  <span class="fu"><a href="../reference/legendBottom.html">legendNone</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">surface_plot</span> <span class="op">+</span>
  <span class="va">order_averaged</span> </code></pre></div>
<p><img src="cc-spatial-trajectory-screening_files/figure-html/unnamed-chunk-14-1.png" width="50%"><img src="cc-spatial-trajectory-screening_files/figure-html/unnamed-chunk-14-2.png" width="50%"></p>
<p>Using the <em>barcodes</em>-variable as the id variable
expression-values (or any other kind of numeric variable) can be joined
to the data.frame containing the arranged and grouped barcode-spots as
shown in the data.frame below.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">genes_of_interest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"EGFR"</span>, <span class="st">"MAG"</span><span class="op">)</span>

<span class="va">joined_df</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="../reference/joinWith.html">joinWith</a></span><span class="op">(</span>
    object <span class="op">=</span> <span class="va">object_t269</span>,
    spata_df <span class="op">=</span> <span class="va">barcode_spots_binned</span>, 
    genes <span class="op">=</span> <span class="va">genes_of_interest</span>
  <span class="op">)</span>
  
<span class="co"># show results </span>
<span class="va">joined_df</span></code></pre></div>
<pre><code><span class="co">## <span style="color: #949494;"># A tibble: 1,623 x 8</span></span>
<span class="co">##    barcodes          sample     x     y projection_length bins_order  EGFR   MAG</span>
<span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;"> 1</span> GATCGGATAGAACCAT~ 269_T   340.  939.             0.225 (-1.03,12~ 0.624     0</span>
<span class="co">## <span style="color: #BCBCBC;"> 2</span> ACGCTGTGAGGCGTAG~ 269_T   341.  983.             0.624 (-1.03,12~ 0.659     0</span>
<span class="co">## <span style="color: #BCBCBC;"> 3</span> GTCTACTCAATTACAA~ 269_T   341. <span style="text-decoration: underline;">1</span>026.             1.02  (-1.03,12~ 0.867     0</span>
<span class="co">## <span style="color: #BCBCBC;"> 4</span> CACTCGGTTAGGAGGA~ 269_T   341. <span style="text-decoration: underline;">1</span>070              1.42  (-1.03,12~ 0.659     0</span>
<span class="co">## <span style="color: #BCBCBC;"> 5</span> GGTTGTGTAGCCTGGC~ 269_T   342. <span style="text-decoration: underline;">1</span>113.             2.22  (-1.03,12~ 0.813     0</span>
<span class="co">## <span style="color: #BCBCBC;"> 6</span> GCGTTATATTTGGAAC~ 269_T   343. <span style="text-decoration: underline;">1</span>157.             2.62  (-1.03,12~ 0.624     0</span>
<span class="co">## <span style="color: #BCBCBC;"> 7</span> GTCAGTTTGGTAGTCG~ 269_T   343. <span style="text-decoration: underline;">1</span>200.             3.02  (-1.03,12~ 0.813     0</span>
<span class="co">## <span style="color: #BCBCBC;"> 8</span> GCTAAGTAAAGGCGAT~ 269_T   343. <span style="text-decoration: underline;">1</span>244              3.42  (-1.03,12~ 0.483     0</span>
<span class="co">## <span style="color: #BCBCBC;"> 9</span> GCTCGCGGTTCCGCTC~ 269_T   344. <span style="text-decoration: underline;">1</span>288.             3.82  (-1.03,12~ 0.416     0</span>
<span class="co">## <span style="color: #BCBCBC;">10</span> GCAGATCCTCGCAAAT~ 269_T   344. <span style="text-decoration: underline;">1</span>331.             4.22  (-1.03,12~ 0.792     0</span>
<span class="co">## <span style="color: #949494;"># i 1,613 more rows</span></span></code></pre>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">averaged_df</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">joined_df</span>, <span class="va">bins_order</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>
    <span class="fu"><a href="../reference/across.html">across</a></span><span class="op">(</span>
      .cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">any_of</a></span><span class="op">(</span><span class="va">genes_of_interest</span><span class="op">)</span>,
      .fns <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span> 
    <span class="op">)</span>
  <span class="op">)</span>
    
<span class="co"># show results</span>
<span class="va">averaged_df</span></code></pre></div>
<pre><code><span class="co">## <span style="color: #949494;"># A tibble: 10 x 3</span></span>
<span class="co">##    bins_order           EGFR     MAG</span>
<span class="co">##    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>               <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;"> 1</span> (-1.03,126]         0.707 0.007<span style="text-decoration: underline;">38</span></span>
<span class="co">## <span style="color: #BCBCBC;"> 2</span> (126,251]           0.734 0.004<span style="text-decoration: underline;">74</span></span>
<span class="co">## <span style="color: #BCBCBC;"> 3</span> (251,376]           0.749 0.009<span style="text-decoration: underline;">20</span></span>
<span class="co">## <span style="color: #BCBCBC;"> 4</span> (376,502]           0.748 0.038<span style="text-decoration: underline;">1</span> </span>
<span class="co">## <span style="color: #BCBCBC;"> 5</span> (502,627]           0.666 0.278  </span>
<span class="co">## <span style="color: #BCBCBC;"> 6</span> (627,753]           0.483 0.325  </span>
<span class="co">## <span style="color: #BCBCBC;"> 7</span> (753,878]           0.350 0.110  </span>
<span class="co">## <span style="color: #BCBCBC;"> 8</span> (878,1e+03]         0.275 0.061<span style="text-decoration: underline;">5</span> </span>
<span class="co">## <span style="color: #BCBCBC;"> 9</span> (1e+03,1.13e+03]    0.202 0.050<span style="text-decoration: underline;">1</span> </span>
<span class="co">## <span style="color: #BCBCBC;">10</span> (1.13e+03,1.26e+03] 0.223 0.045<span style="text-decoration: underline;">8</span></span></code></pre>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">normalized_df</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="va">averaged_df</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>
    <span class="fu"><a href="../reference/across.html">across</a></span><span class="op">(</span>
      .cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">any_of</a></span><span class="op">(</span><span class="va">genes_of_interest</span><span class="op">)</span>,
      .fns <span class="op">=</span> <span class="fu">confuns</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/confuns/man/normalize.html" class="external-link">normalize</a></span>
    <span class="op">)</span>
  <span class="op">)</span>

<span class="co"># show results </span>
<span class="va">normalized_df</span></code></pre></div>
<pre><code><span class="co">## <span style="color: #949494;"># A tibble: 10 x 3</span></span>
<span class="co">##    bins_order            EGFR     MAG</span>
<span class="co">##    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>                <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;"> 1</span> (-1.03,126]         0.924  0.008<span style="text-decoration: underline;">24</span></span>
<span class="co">## <span style="color: #BCBCBC;"> 2</span> (126,251]           0.973  0      </span>
<span class="co">## <span style="color: #BCBCBC;"> 3</span> (251,376]           1      0.013<span style="text-decoration: underline;">9</span> </span>
<span class="co">## <span style="color: #BCBCBC;"> 4</span> (376,502]           0.999  0.104  </span>
<span class="co">## <span style="color: #BCBCBC;"> 5</span> (502,627]           0.849  0.852  </span>
<span class="co">## <span style="color: #BCBCBC;"> 6</span> (627,753]           0.513  1      </span>
<span class="co">## <span style="color: #BCBCBC;"> 7</span> (753,878]           0.270  0.328  </span>
<span class="co">## <span style="color: #BCBCBC;"> 8</span> (878,1e+03]         0.133  0.177  </span>
<span class="co">## <span style="color: #BCBCBC;"> 9</span> (1e+03,1.13e+03]    0      0.141  </span>
<span class="co">## <span style="color: #BCBCBC;">10</span> (1.13e+03,1.26e+03] 0.038<span style="text-decoration: underline;">4</span> 0.128</span></code></pre>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">plot_df</span> <span class="op">&lt;-</span> 
  <span class="co"># shift to use facet_wrap</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>
    data <span class="op">=</span> <span class="va">normalized_df</span>, 
    cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">any_of</a></span><span class="op">(</span><span class="va">genes_of_interest</span><span class="op">)</span>,
    names_to <span class="op">=</span> <span class="st">"genes"</span>,
    values_to <span class="op">=</span> <span class="st">"values"</span>
  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>trajectory_order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">bins_order</span><span class="op">)</span><span class="op">)</span> 

<span class="va">traj_plots</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span>
    .x <span class="op">=</span> <span class="va">genes_of_interest</span>,
    .f <span class="op">=</span> <span class="op">~</span> 
      <span class="fu"><a href="../reference/plotSpatialTrajectories.html">plotSpatialTrajectories</a></span><span class="op">(</span>
        object <span class="op">=</span> <span class="va">object_t269</span>,
        ids <span class="op">=</span> <span class="st">"horizontal_mid"</span>,
        color_by <span class="op">=</span> <span class="va">.x</span>, 
        sgmt_size <span class="op">=</span> <span class="fl">1</span>
        <span class="op">)</span> 
  <span class="op">)</span> 

<span class="co"># plot results</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">plot_df</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">trajectory_order</span>, y <span class="op">=</span> <span class="va">values</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"blue"</span>, size <span class="op">=</span> <span class="fl">2.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_path</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span>
    alpha <span class="op">=</span> <span class="fl">0.5</span>, 
    color <span class="op">=</span> <span class="st">"red"</span>,
    method <span class="op">=</span> <span class="st">"loess"</span>, 
    formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">x</span>, 
    span <span class="op">=</span> <span class="fl">0.5</span>
    <span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_bins</span>, labels <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_bins</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span>facets <span class="op">=</span> <span class="va">.</span> <span class="op">~</span> <span class="va">genes</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Trajectory Order (Bins)"</span>, y <span class="op">=</span> <span class="st">"Inferred Expression"</span><span class="op">)</span> <span class="op">|</span> <span class="co"># use patchwork | operator</span>
  <span class="op">(</span><span class="va">traj_plots</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">/</span> <span class="va">traj_plots</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<p><img src="cc-spatial-trajectory-screening_files/figure-html/unnamed-chunk-15-1.png" width="100%"></p>
<p>This is what happens in <code><a href="../reference/plotTrajectoryLineplot.html">plotTrajectoryLineplot()</a></code> and
<code><a href="../reference/plotTrajectoryHeatmap.html">plotTrajectoryHeatmap()</a></code>.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">traj_df</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/SPATA2/man/getTrajectoryDf.html" class="external-link">getTrajectoryDf</a></span><span class="op">(</span>
    object <span class="op">=</span> <span class="va">object_t269</span>,
    id <span class="op">=</span> <span class="st">"horizontal_mid"</span>,
    variables <span class="op">=</span> <span class="va">genes_of_interest</span>,
    format <span class="op">=</span> <span class="st">"wide"</span>
  <span class="op">)</span>

<span class="co"># show results</span>
<span class="va">traj_df</span></code></pre></div>
<pre><code><span class="co">## <span style="color: #949494;"># A tibble: 1,733 x 8</span></span>
<span class="co">##    barcodes     sample     x     y projection_length trajectory_part  EGFR   MAG</span>
<span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;"> 1</span> TGCGAATATGG~ 269_T   339.  852.             0.116 Part 1          0.746 0    </span>
<span class="co">## <span style="color: #BCBCBC;"> 2</span> TTGTGAGGCAT~ 269_T   340.  896.             0.915 Part 1          0.746 0.245</span>
<span class="co">## <span style="color: #BCBCBC;"> 3</span> GATCGGATAGA~ 269_T   340.  939.             1.32  Part 1          0.624 0    </span>
<span class="co">## <span style="color: #BCBCBC;"> 4</span> ACGCTGTGAGG~ 269_T   341.  983.             1.71  Part 1          0.659 0    </span>
<span class="co">## <span style="color: #BCBCBC;"> 5</span> GTCTACTCAAT~ 269_T   341. <span style="text-decoration: underline;">1</span>026.             2.11  Part 1          0.867 0    </span>
<span class="co">## <span style="color: #BCBCBC;"> 6</span> CACTCGGTTAG~ 269_T   341. <span style="text-decoration: underline;">1</span>070              2.51  Part 1          0.659 0    </span>
<span class="co">## <span style="color: #BCBCBC;"> 7</span> GGTTGTGTAGC~ 269_T   342. <span style="text-decoration: underline;">1</span>113.             3.31  Part 1          0.813 0    </span>
<span class="co">## <span style="color: #BCBCBC;"> 8</span> GCGTTATATTT~ 269_T   343. <span style="text-decoration: underline;">1</span>157.             3.71  Part 1          0.624 0    </span>
<span class="co">## <span style="color: #BCBCBC;"> 9</span> GTCAGTTTGGT~ 269_T   343. <span style="text-decoration: underline;">1</span>200.             4.11  Part 1          0.813 0    </span>
<span class="co">## <span style="color: #BCBCBC;">10</span> GCTAAGTAAAG~ 269_T   343. <span style="text-decoration: underline;">1</span>244              4.51  Part 1          0.483 0    </span>
<span class="co">## <span style="color: #949494;"># i 1,723 more rows</span></span></code></pre>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plotTrajectoryLineplot.html">plotTrajectoryLineplot</a></span><span class="op">(</span>
  object <span class="op">=</span> <span class="va">object_t269</span>,
  id <span class="op">=</span> <span class="st">"horizontal_mid"</span>,
  variables <span class="op">=</span> <span class="va">genes_of_interest</span>, 
  ncol <span class="op">=</span> <span class="fl">1</span>, 
  n_bins <span class="op">=</span> <span class="va">n_bins</span>,
  smooth_span <span class="op">=</span> <span class="fl">0.5</span>
<span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span>

<span class="fu"><a href="../reference/plotTrajectoryHeatmap.html">plotTrajectoryHeatmap</a></span><span class="op">(</span>
  object <span class="op">=</span> <span class="va">object_t269</span>,
  id <span class="op">=</span> <span class="st">"horizontal_mid"</span>,
  variables <span class="op">=</span> <span class="va">genes_of_interest</span>, 
  smooth_span <span class="op">=</span> <span class="fl">0.2</span>
<span class="op">)</span></code></pre></div>
<p><img src="cc-spatial-trajectory-screening_files/figure-html/unnamed-chunk-16-1.png" width="50%"><img src="cc-spatial-trajectory-screening_files/figure-html/unnamed-chunk-16-2.png" width="50%"></p>
</div>
<div class="section level2">
<h2 id="binwidth-vs--number-of-bins">5. Binwidth vs. number of bins<a class="anchor" aria-label="anchor" href="#binwidth-vs--number-of-bins"></a>
</h2>
<p>The resolution of the binning is set up via the argument
<code>n_bins</code> which explicitly specifies the number of bins
<strong>or</strong> <code>binwidth</code> which specifies the width of
each bin. For visualization purposes we chose <code>n_bins</code>in the
example above but we recommend to use the argument <code>binwidth</code>
and setting it to the distance between the barcode-spots using
<code><a href="../reference/getCCD.html">getCCD()</a></code>. This results in bins that contain one layer of
barcode-spot each.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bcsp_dist</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getCCD.html">getCCD</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">object_t269</span>, unit <span class="op">=</span> <span class="st">"px"</span><span class="op">)</span>

<span class="co"># show results</span>
<span class="va">bcsp_dist</span></code></pre></div>
<pre><code><span class="co">## [1] 25.1044</span>
<span class="co">## attr(,"unit")</span>
<span class="co">## [1] "px"</span></code></pre>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">traj_df_small</span> <span class="op">&lt;-</span> 
  <span class="va">traj_obj</span><span class="op">@</span><span class="va">projection</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">projection_length</span> <span class="op">&lt;=</span> <span class="op">(</span><span class="fu"><a href="../reference/getCCD.html">getCCD</a></span><span class="op">(</span><span class="va">object_t269</span>, <span class="st">"px"</span><span class="op">)</span><span class="op">*</span><span class="fl">20</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>projection_length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">projection_length</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu">bin_projection_df</span><span class="op">(</span>binwidth <span class="op">=</span> <span class="va">bcsp_dist</span>, n_bins <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>proj_length_binned <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">proj_length_binned</span><span class="op">)</span><span class="op">)</span> 

<span class="co"># plot results</span>
<span class="va">surface_plot</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>
    data <span class="op">=</span> <span class="va">traj_df_small</span>, 
    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, color <span class="op">=</span> <span class="va">proj_length_binned</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="../reference/scale_color_add_on.html">scale_color_add_on</a></span><span class="op">(</span>
    variable <span class="op">=</span> <span class="va">traj_df_small</span><span class="op">[[</span><span class="st">"proj_length_binned"</span><span class="op">]</span><span class="op">]</span>, 
    clrp <span class="op">=</span> <span class="st">"milo"</span>
    <span class="op">)</span> <span class="op">+</span> 
  <span class="va">trajectory</span></code></pre></div>
<p><img src="cc-spatial-trajectory-screening_files/figure-html/unnamed-chunk-17-1.png" width="50%"></p>
</div>
<div class="section level2">
<h2 id="screening-gene-expression-changes">6. Screening gene expression changes<a class="anchor" aria-label="anchor" href="#screening-gene-expression-changes"></a>
</h2>
<p>Click <a href="cc-model-fitting-in-spatial-transcriptomic-studies.html">here</a>
to be guided to the vignette that explains how the inferred expression
changes are fitted to models to find biologically relevant dynamics
along the trajectory.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Jan Kueckelhaus, Dieter-Henrik Heiland.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
